(()=>{var hn=Object.create;var kt=Object.defineProperty;var cn=Object.getOwnPropertyDescriptor;var dn=Object.getOwnPropertyNames;var pn=Object.getPrototypeOf,mn=Object.prototype.hasOwnProperty;var gn=(n,t,e)=>t in n?kt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var xn=n=>kt(n,"__esModule",{value:!0});var _n=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports);var yn=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of dn(t))!mn.call(n,s)&&(e||s!=="default")&&kt(n,s,{get:()=>t[s],enumerable:!(r=cn(t,s))||r.enumerable});return n},bn=(n,t)=>yn(xn(kt(n!=null?hn(pn(n)):{},"default",!t&&n&&n.__esModule?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n);var W=(n,t,e)=>(gn(n,typeof t!="symbol"?t+"":t,e),e);var cr=_n((vo,Yt)=>{(function(){function n(t,e,r,s){this.max_objects=e||10,this.max_levels=r||4,this.level=s||0,this.bounds=t,this.objects=[],this.nodes=[]}n.prototype.split=function(){var t=this.level+1,e=this.bounds.width/2,r=this.bounds.height/2,s=this.bounds.x,o=this.bounds.y;this.nodes[0]=new n({x:s+e,y:o,width:e,height:r},this.max_objects,this.max_levels,t),this.nodes[1]=new n({x:s,y:o,width:e,height:r},this.max_objects,this.max_levels,t),this.nodes[2]=new n({x:s,y:o+r,width:e,height:r},this.max_objects,this.max_levels,t),this.nodes[3]=new n({x:s+e,y:o+r,width:e,height:r},this.max_objects,this.max_levels,t)},n.prototype.getIndex=function(t){var e=[],r=this.bounds.x+this.bounds.width/2,s=this.bounds.y+this.bounds.height/2,o=t.y<s,a=t.x<r,l=t.x+t.width>r,f=t.y+t.height>s;return o&&l&&e.push(0),a&&o&&e.push(1),a&&f&&e.push(2),l&&f&&e.push(3),e},n.prototype.insert=function(t){var e=0,r;if(this.nodes.length){for(r=this.getIndex(t),e=0;e<r.length;e++)this.nodes[r[e]].insert(t);return}if(this.objects.push(t),this.objects.length>this.max_objects&&this.level<this.max_levels){for(this.nodes.length||this.split(),e=0;e<this.objects.length;e++){r=this.getIndex(this.objects[e]);for(var s=0;s<r.length;s++)this.nodes[r[s]].insert(this.objects[e])}this.objects=[]}},n.prototype.retrieve=function(t){var e=this.getIndex(t),r=this.objects;if(this.nodes.length)for(var s=0;s<e.length;s++)r=r.concat(this.nodes[e[s]].retrieve(t));return r=r.filter(function(o,a){return r.indexOf(o)>=a}),r},n.prototype.clear=function(){this.objects=[];for(var t=0;t<this.nodes.length;t++)this.nodes.length&&this.nodes[t].clear();this.nodes=[]},typeof Yt<"u"&&typeof Yt.exports<"u"?Yt.exports=n:window.Quadtree=n})()});var d;function Le(n){d=n}var wn={CCW:-1,CW:1,NOT_ORIENTABLE:0},vn=2*Math.PI,xt=1,We=0,R=2,En=3,In=4,Tn=1,Sn=2,ge=0,Mt=1,et=2,Ft=Object.freeze({CCW:!0,CW:!1,ORIENTATION:wn,PIx2:vn,INSIDE:xt,OUTSIDE:We,BOUNDARY:R,CONTAINS:En,INTERLACE:In,OVERLAP_SAME:Tn,OVERLAP_OPPOSITE:Sn,NOT_VERTEX:ge,START_VERTEX:Mt,END_VERTEX:et}),$=1e-6;function Ge(n){$=n}function De(){return $}var An=3;function ae(n){return n<$&&n>-$}function H(n,t){return n-t<$&&n-t>-$}function ze(n,t){return n-t>$}function Pn(n,t){return n-t>-$}function Qe(n,t){return n-t<-$}function Cn(n,t){return n-t<$}var On=Object.freeze({setTolerance:Ge,getTolerance:De,DECIMALS:An,EQ_0:ae,EQ:H,GT:ze,GE:Pn,LT:Qe,LE:Cn}),$t=class{static get ILLEGAL_PARAMETERS(){return new ReferenceError("Illegal Parameters")}static get ZERO_DIVISION(){return new Error("Zero division")}static get UNRESOLVED_BOUNDARY_CONFLICT(){return new Error("Unresolved boundary conflict in boolean operation")}static get INFINITE_LOOP(){return new Error("Infinite loop")}};var i={Utils:On,Errors:$t,Matrix:void 0,Planar_set:void 0,Point:void 0,Vector:void 0,Line:void 0,Circle:void 0,Segment:void 0,Arc:void 0,Box:void 0,Edge:void 0,Face:void 0,Ray:void 0,Ray_shooting:void 0,Multiline:void 0,Polygon:void 0,Distance:void 0,Inversion:void 0};for(let n in Ft)i[n]=Ft[n];Object.defineProperty(i,"DP_TOL",{get:function(){return De()},set:function(n){Ge(n)}});var Ut=class{constructor(t,e){this.first=t,this.last=e||this.first}static testInfiniteLoop(t){let e=t,r=t;do{if(e!=t&&e===r)throw i.Errors.INFINITE_LOOP;e=e.next,r=r.next.next}while(e!=t)}get size(){let t=0;for(let e of this)t++;return t}toArray(t=void 0,e=void 0){let r=[],s=t||this.first,o=e||this.last,a=s;if(a===void 0)return r;do r.push(a),a=a.next;while(a!==o.next);return r}append(t){return this.isEmpty()?this.first=t:(t.prev=this.last,this.last.next=t),this.last=t,this.last.next=void 0,this.first.prev=void 0,this}insert(t,e){if(this.isEmpty())this.first=t,this.last=t;else if(e==null)t.next=this.first,this.first.prev=t,this.first=t;else{let r=e.next;e.next=t,r&&(r.prev=t),t.prev=e,t.next=r,this.last===e&&(this.last=t)}return this.last.next=void 0,this.first.prev=void 0,this}remove(t){return t===this.first&&t===this.last?(this.first=void 0,this.last=void 0):(t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t===this.first&&(this.first=t.next),t===this.last&&(this.last=t.prev)),this}isEmpty(){return this.first===void 0}[Symbol.iterator](){let t;return{next:()=>(t=t?t.next:this.first,{value:t,done:t===void 0})}}};function it(n,t,e){let r=e.length,s=n.shape.split(t);if(s.length===0)return;let o=0;s[0]===null?o=0:s[1]===null?o=n.shape.length:o=s[0].length;let a=ge;H(o,0)&&(a|=Mt),H(o,n.shape.length)&&(a|=et);let l=a&et&&n.next.arc_length===0?0:n.arc_length+o;e.push({id:r,pt:t,arc_length:l,edge_before:n,edge_after:void 0,face:n.face,is_vertex:a})}function bt(n){n.int_points1_sorted=_t(n.int_points1),n.int_points2_sorted=_t(n.int_points2)}function _t(n){let t=new Map,e=0;for(let s of n)t.has(s.face)||(t.set(s.face,e),e++);for(let s of n)s.faceId=t.get(s.face);return n.slice().sort(Nn)}function Nn(n,t){return n.faceId<t.faceId?-1:n.faceId>t.faceId?1:n.arc_length<t.arc_length?-1:n.arc_length>t.arc_length?1:0}function ie(n,t){return t.slice().sort((e,r)=>n.coord(e.pt)<n.coord(r.pt)?-1:n.coord(e.pt)>n.coord(r.pt)?1:0)}function xe(n){if(n.int_points1.length<2)return;let t=!1,e,r,s,o;for(let a=0;a<n.int_points1_sorted.length;a++)if(n.int_points1_sorted[a].id!==-1){e=n.int_points1_sorted[a],r=n.int_points2[e.id];for(let l=a+1;l<n.int_points1_sorted.length&&(s=n.int_points1_sorted[l],!!H(s.arc_length,e.arc_length));l++)s.id!==-1&&(o=n.int_points2[s.id],o.id!==-1&&s.edge_before===e.edge_before&&s.edge_after===e.edge_after&&o.edge_before===r.edge_before&&o.edge_after===r.edge_after&&(s.id=-1,o.id=-1,t=!0))}r=n.int_points2_sorted[0],e=n.int_points1[r.id];for(let a=1;a<n.int_points2_sorted.length;a++){let l=n.int_points2_sorted[a];if(l.id==-1)continue;if(r.id==-1||!H(l.arc_length,r.arc_length)){r=l,e=n.int_points1[r.id];continue}let f=n.int_points1[l.id];f.edge_before===e.edge_before&&f.edge_after===e.edge_after&&l.edge_before===r.edge_before&&l.edge_after===r.edge_after&&(f.id=-1,l.id=-1,t=!0)}t&&(n.int_points1=n.int_points1.filter(a=>a.id>=0),n.int_points2=n.int_points2.filter(a=>a.id>=0),n.int_points1.forEach((a,l)=>a.id=l),n.int_points2.forEach((a,l)=>a.id=l))}function le(n){for(let t of n)t.edge_before.bvStart=void 0,t.edge_before.bvEnd=void 0,t.edge_before.bv=void 0,t.edge_before.overlap=void 0,t.edge_after.bvStart=void 0,t.edge_after.bvEnd=void 0,t.edge_after.bv=void 0,t.edge_after.overlap=void 0;for(let t of n)t.edge_before.bvEnd=R,t.edge_after.bvStart=R}function fe(n,t){for(let e of n)e.edge_before.setInclusion(t),e.edge_after.setInclusion(t)}function kn(n){let t,e,r,s=n.int_points1.length;for(let o=0;o<s;o++){let a=n.int_points1_sorted[o];a.face!==t&&(e=o,t=a.face);let l=o,f=st(n.int_points1_sorted,o,t),u;l+f<s&&n.int_points1_sorted[l+f].face===t?u=l+f:u=e;let h=st(n.int_points1_sorted,u,t);r=null;for(let b=u;b<u+h;b++){let I=n.int_points1_sorted[b];if(I.face===t&&n.int_points2[I.id].face===n.int_points2[a.id].face){r=I;break}}if(r===null)continue;let c=a.edge_after,g=r.edge_before;if(!(c.bv===R&&g.bv===R)||c!==g)continue;let _=n.int_points2[a.id],v=n.int_points2[r.id],w=_.edge_after,E=v.edge_before;w.bv===R&&E.bv===R&&w===E||(_=n.int_points2[r.id],v=n.int_points2[a.id],w=_.edge_after,E=v.edge_before),w.bv===R&&E.bv===R&&w===E&&c.setOverlap(w)}}function st(n,t,e){let r,s,o=1;if(n.length==1)return 1;r=n[t];for(let a=t+1;a<n.length&&!(r.face!=e||(s=n[a],!(s.pt.equalTo(r.pt)&&s.edge_before===r.edge_before&&s.edge_after===r.edge_after)));a++)o++;return o}function ot(n,t){if(!!t){for(let e of t){let r=e.edge_before;if(e.is_vertex=ge,r.shape.start&&r.shape.start.equalTo(e.pt)&&(e.is_vertex|=Mt),r.shape.end&&r.shape.end.equalTo(e.pt)&&(e.is_vertex|=et),e.is_vertex&Mt){e.edge_before=r.prev,e.is_vertex=et;continue}if(e.is_vertex&et)continue;let s=n.addVertex(e.pt,r);e.edge_before=s}for(let e of t)e.edge_after=e.edge_before.next}}function Be(n,t,e){let r=n.edge_before,s=t.edge_after;r.next=e,e.prev=r,e.next=s,s.prev=e}var{INSIDE:M,OUTSIDE:F,BOUNDARY:T,OVERLAP_SAME:Ln,OVERLAP_OPPOSITE:Bn}=Ft,{NOT_VERTEX:yo,START_VERTEX:Re,END_VERTEX:Me}=Ft,Vt=1,Et=2,X=3;function Rn(n,t){let[e,r]=It(n,t,Vt,!0);return e}function ue(n,t){let r=t.clone().reverse(),[s,o]=It(n,r,X,!0);return s}function Ye(n,t){let[e,r]=It(n,t,Et,!0);return e}function Je(n,t){let[e,r]=It(n,t,Et,!1),s=[];for(let a of e.faces)s=[...s,...[...a.edges].map(l=>l.shape)];let o=[];for(let a of r.faces)o=[...o,...[...a.edges].map(l=>l.shape)];return[s,o]}function he(n,t){let[e,r]=It(n,t,X,!1),s=[];for(let o of e.faces)s=[...s,...[...o.edges].map(a=>a.shape)];return s}function He(n,t){let e=n.clone(),r=t.clone(),s=Xe(e,r);bt(s),ot(e,s.int_points1_sorted),ot(r,s.int_points2_sorted),xe(s),bt(s);let o=s.int_points1_sorted.map(l=>l.pt),a=s.int_points2_sorted.map(l=>l.pt);return[o,a]}function Mn(n,t,e,r){let s=Fe(n,e.int_points1),o=Fe(t,e.int_points2);for($e(s,t),$e(o,n),le(e.int_points1),le(e.int_points2),fe(e.int_points1,t),fe(e.int_points2,n);$n(n,t,e.int_points1,e.int_points1_sorted,e.int_points2,e););kn(e),ce(n,r,e.int_points1_sorted,!0),ce(t,r,e.int_points2_sorted,!1),Ue(n,s,r,!0),Ue(t,o,r,!1)}function Fn(n,t,e,r){Un(n,t,r,e.int_points2),Vn(n,t,e),de(n,e.int_points1),de(t,e.int_points2),pe(n,e.int_points1,e.int_points2),pe(n,e.int_points2,e.int_points1)}function It(n,t,e,r){let s=n.clone(),o=t.clone(),a=Xe(s,o);return bt(a),ot(s,a.int_points1_sorted),ot(o,a.int_points2_sorted),xe(a),bt(a),Mn(s,o,a,e),r&&Fn(s,o,a,e),[s,o]}function Xe(n,t){let e={int_points1:[],int_points2:[]};for(let r of n.edges){let s=t.edges.search(r.box);for(let o of s){let a=r.shape.intersect(o.shape);for(let l of a)it(r,l,e.int_points1),it(o,l,e.int_points2)}}return e}function Fe(n,t){let e=[];for(let r of n.faces)t.find(s=>s.face===r)||e.push(r);return e}function $e(n,t){for(let e of n)e.first.bv=e.first.bvStart=e.first.bvEnd=void 0,e.first.setInclusion(t)}function $n(n,t,e,r,s,o){let a,l,f,u=r.length,h=!1;for(let c=0;c<u;c++){let g=r[c];g.face!==a&&(l=c,a=g.face);let _=c,v=st(r,c,a),w;_+v<u&&r[_+v].face===a?w=_+v:w=l;let E=st(r,w,a);f=null;for(let x=w;x<w+E;x++){let C=r[x];if(C.face===a&&s[C.id].face===s[g.id].face){f=C;break}}if(f===null)continue;let b=g.edge_after,I=f.edge_before;if(b.bv===T&&I.bv!=T){b.bv=I.bv;continue}if(b.bv!=T&&I.bv===T){I.bv=b.bv;continue}if(b.bv===T&&I.bv===T&&b!=I||b.bv===M&&I.bv===F||b.bv===F&&I.bv===M){let x=b.next;for(;x!=I;)x.bvStart=void 0,x.bvEnd=void 0,x.bv=void 0,x.setInclusion(t),x=x.next}if(b.bv===T&&I.bv===T&&b!=I){let x=b.next,C;for(;x!=I;){if(x.bv!=T){if(C===void 0)C=x.bv;else if(x.bv!=C)throw $t.UNRESOLVED_BOUNDARY_CONFLICT}x=x.next}C!=null&&(b.bv=C,I.bv=C);continue}if(b.bv===M&&I.bv===F||b.bv===F&&I.bv===M){let x=b;for(;x!=I;){if(x.bvStart===b.bv&&x.bvEnd===I.bv){let[C,ne]=x.shape.distanceTo(t);if(C<10*i.DP_TOL){it(x,ne.ps,e);let j=e[e.length-1];if(j.is_vertex&Re)j.edge_after=x,j.edge_before=x.prev,x.bvStart=T,x.bv=void 0,x.setInclusion(t);else if(j.is_vertex&Me)j.edge_after=x.next,x.bvEnd=T,x.bv=void 0,x.setInclusion(t);else{let B=t.addVertex(j.pt,x);j.edge_before=B,j.edge_after=B.next,B.setInclusion(t),B.next.bvStart=T,B.next.bvEnd=void 0,B.next.bv=void 0,B.next.setInclusion(t)}let tt=t.findEdgeByPoint(ne.pe);it(tt,ne.pe,s);let q=s[s.length-1];if(q.is_vertex&Re)q.edge_after=tt,q.edge_before=tt.prev;else if(q.is_vertex&Me)q.edge_after=tt.next;else{let B=s.find(un=>un.edge_after===tt),k=t.addVertex(q.pt,tt);q.edge_before=k,q.edge_after=k.next,B&&(B.edge_after=k),k.bvStart=void 0,k.bvEnd=T,k.bv=void 0,k.setInclusion(n),k.next.bvStart=T,k.next.bvEnd=void 0,k.next.bv=void 0,k.next.setInclusion(n)}bt(o),h=!0;break}}x=x.next}if(h)break;throw $t.UNRESOLVED_BOUNDARY_CONFLICT}}return h}function ce(n,t,e,r){if(!e)return;let s,o,a,l;for(let f=0;f<e.length;f++){if(a=e[f],a.face!==s&&(o=f,s=a.face),s.isEmpty())continue;let u=f,h=st(e,f,s),c;u+h<e.length&&e[u+h].face===a.face?c=u+h:c=o,l=e[c];let g=c,_=st(e,g,s),v=a.edge_after,w=l.edge_before;if(v.bv===M&&w.bv===M&&t===Vt||v.bv===F&&w.bv===F&&t===Et||(v.bv===F||w.bv===F)&&t===X&&!r||(v.bv===M||w.bv===M)&&t===X&&r||v.bv===T&&w.bv===T&&v.overlap&Ln&&r||v.bv===T&&w.bv===T&&v.overlap&Bn){n.removeChain(s,v,w);for(let E=u;E<u+h;E++)e[E].edge_after=void 0;for(let E=g;E<g+_;E++)e[E].edge_before=void 0}f+=h-1}}function Un(n,t,e,r){for(let s of t.faces){for(let o of s)n.edges.add(o);r.find(o=>o.face===s)===void 0&&n.addFace(s.first,s.last)}}function Vn(n,t,e){if(e.int_points1.length!==0)for(let r=0;r<e.int_points1.length;r++){let s=e.int_points1[r],o=e.int_points2[r];if(s.edge_before!==void 0&&s.edge_after===void 0&&o.edge_before===void 0&&o.edge_after!==void 0&&(s.edge_before.next=o.edge_after,o.edge_after.prev=s.edge_before,s.edge_after=o.edge_after,o.edge_before=s.edge_before),o.edge_before!==void 0&&o.edge_after===void 0&&s.edge_before===void 0&&s.edge_after!==void 0&&(o.edge_before.next=s.edge_after,s.edge_after.prev=o.edge_before,o.edge_after=s.edge_after,s.edge_before=o.edge_before),s.edge_before!==void 0&&s.edge_after===void 0)for(let a of e.int_points1_sorted)a!==s&&a.edge_before===void 0&&a.edge_after!==void 0&&a.pt.equalTo(s.pt)&&(s.edge_before.next=a.edge_after,a.edge_after.prev=s.edge_before,s.edge_after=a.edge_after,a.edge_before=s.edge_before);if(o.edge_before!==void 0&&o.edge_after===void 0)for(let a of e.int_points2_sorted)a!==o&&a.edge_before===void 0&&a.edge_after!==void 0&&a.pt.equalTo(o.pt)&&(o.edge_before.next=a.edge_after,a.edge_after.prev=o.edge_before,o.edge_after=a.edge_after,a.edge_before=o.edge_before)}}function de(n,t){for(let e of t)n.faces.delete(e.face),e.face=void 0,e.edge_before&&(e.edge_before.face=void 0),e.edge_after&&(e.edge_after.face=void 0)}function pe(n,t,e){for(let r of t){if(r.edge_before===void 0||r.edge_after===void 0||r.face||r.edge_after.face||r.edge_before.face)continue;let s=r.edge_after,o=r.edge_before;Ut.testInfiniteLoop(s);let a=n.addFace(s,o);for(let l of t)l.edge_before&&l.edge_after&&l.edge_before.face===a&&l.edge_after.face===a&&(l.face=a);for(let l of e)l.edge_before&&l.edge_after&&l.edge_before.face===a&&l.edge_after.face===a&&(l.face=a)}}function Ue(n,t,e,r){for(let s of t){let o=s.first.bv;(e===Vt&&o===M||e===X&&o===M&&r||e===X&&o===F&&!r||e===Et&&o===F)&&n.deleteFace(s)}}var jn=Object.freeze({BOOLEAN_UNION:Vt,BOOLEAN_INTERSECT:Et,BOOLEAN_SUBTRACT:X,unify:Rn,subtract:ue,intersect:Ye,innerClip:Je,outerClip:he,calculateIntersections:He,removeNotRelevantChains:ce,removeOldFaces:de,restoreFaces:pe}),qn=RegExp("T.F..FFF.|T.F...F.."),Wn=RegExp("T........|.T.......|...T.....|....T...."),Gn=RegExp("FT.......|F..T.....|F...T...."),Dn=RegExp("T.F..F..."),zn=RegExp("T.F..F...|.TF..F...|..FT.F...|..F.TF..."),Z=class{constructor(){this.m=new Array(9).fill(void 0)}get I2I(){return this.m[0]}set I2I(t){this.m[0]=t}get I2B(){return this.m[1]}set I2B(t){this.m[1]=t}get I2E(){return this.m[2]}set I2E(t){this.m[2]=t}get B2I(){return this.m[3]}set B2I(t){this.m[3]=t}get B2B(){return this.m[4]}set B2B(t){this.m[4]=t}get B2E(){return this.m[5]}set B2E(t){this.m[5]=t}get E2I(){return this.m[6]}set E2I(t){this.m[6]=t}get E2B(){return this.m[7]}set E2B(t){this.m[7]=t}get E2E(){return this.m[8]}set E2E(t){this.m[8]=t}toString(){return this.m.map(t=>t instanceof Array&&t.length>0?"T":t instanceof Array&&t.length===0?"F":"*").join("")}equal(){return qn.test(this.toString())}intersect(){return Wn.test(this.toString())}touch(){return Gn.test(this.toString())}inside(){return Dn.test(this.toString())}covered(){return zn.test(this.toString())}};function jt(n,t){let e=[],[r,s,o]=n.standard,[a,l,f]=t.standard,u=r*l-s*a,h=o*l-s*f,c=r*f-o*a;if(!i.Utils.EQ_0(u)){let g,_;s===0?(g=o/r,_=c/u):l===0?(g=f/a,_=c/u):r===0?(g=h/u,_=o/s):a===0?(g=h/u,_=f/l):(g=h/u,_=c/u),e.push(new i.Point(g,_))}return e}function lt(n,t){let e=[],r=t.pc.projectionOn(n),s=t.pc.distanceTo(r)[0];if(i.Utils.EQ(s,t.r))e.push(r);else if(i.Utils.LT(s,t.r)){let o=Math.sqrt(t.r*t.r-s*s),a,l;a=n.norm.rotate90CCW().multiply(o),l=r.translate(a),e.push(l),a=n.norm.rotate90CW().multiply(o),l=r.translate(a),e.push(l)}return e}function wt(n,t){let e=[];for(let r of t.toSegments()){let s=qt(r,n);for(let o of s)er(o,e)||e.push(o)}return e}function _e(n,t){let e=[];if(wt(n,t.box).length===0)return e;let r=new i.Circle(t.pc,t.r),s=lt(n,r);for(let o of s)o.on(t)&&e.push(o);return e}function qt(n,t){let e=[];if(n.ps.on(t)&&e.push(n.ps),n.pe.on(t)&&!n.isZeroLength()&&e.push(n.pe),e.length>0||n.isZeroLength()||n.ps.leftTo(t)&&n.pe.leftTo(t)||!n.ps.leftTo(t)&&!n.pe.leftTo(t))return e;let r=new i.Line(n.ps,n.pe);return jt(r,t)}function Tt(n,t){let e=[];if(n.box.not_intersect(t.box))return e;if(n.isZeroLength())return n.ps.on(t)&&e.push(n.ps),e;if(t.isZeroLength())return t.ps.on(n)&&e.push(t.ps),e;let r=new i.Line(n.ps,n.pe),s=new i.Line(t.ps,t.pe);if(r.incidentTo(s))n.ps.on(t)&&e.push(n.ps),n.pe.on(t)&&e.push(n.pe),t.ps.on(n)&&!t.ps.equalTo(n.ps)&&!t.ps.equalTo(n.pe)&&e.push(t.ps),t.pe.on(n)&&!t.pe.equalTo(n.ps)&&!t.pe.equalTo(n.pe)&&e.push(t.pe);else{let o=jt(r,s);o.length>0&&o[0].on(n)&&o[0].on(t)&&e.push(o[0])}return e}function Wt(n,t){let e=[];if(n.box.not_intersect(t.box))return e;if(n.isZeroLength()){let[o,a]=n.ps.distanceTo(t.pc);return i.Utils.EQ(o,t.r)&&e.push(n.ps),e}let r=new i.Line(n.ps,n.pe),s=lt(r,t);for(let o of s)o.on(n)&&e.push(o);return e}function K(n,t){let e=[];if(n.box.not_intersect(t.box))return e;if(n.isZeroLength())return n.ps.on(t)&&e.push(n.ps),e;let r=new i.Line(n.ps,n.pe),s=new i.Circle(t.pc,t.r),o=lt(r,s);for(let a of o)a.on(n)&&a.on(t)&&e.push(a);return e}function Qn(n,t){let e=[];for(let r of t.toSegments()){let s=Tt(r,n);for(let o of s)e.push(o)}return e}function Ke(n,t){let e=[];if(n.box.not_intersect(t.box))return e;let r=new i.Vector(n.pc,t.pc),s=n.r,o=t.r;if(i.Utils.EQ_0(s)||i.Utils.EQ_0(o))return e;if(i.Utils.EQ_0(r.x)&&i.Utils.EQ_0(r.y)&&i.Utils.EQ(s,o))return e.push(n.pc.translate(-s,0)),e;let a=n.pc.distanceTo(t.pc)[0];if(i.Utils.GT(a,s+o)||i.Utils.LT(a,Math.abs(s-o)))return e;r.x/=a,r.y/=a;let l;if(i.Utils.EQ(a,s+o)||i.Utils.EQ(a,Math.abs(s-o)))return l=n.pc.translate(s*r.x,s*r.y),e.push(l),e;let f=s*s/(2*a)-o*o/(2*a)+a/2,u=n.pc.translate(f*r.x,f*r.y),h=Math.sqrt(s*s-f*f);return l=u.translate(r.rotate90CCW().multiply(h)),e.push(l),l=u.translate(r.rotate90CW().multiply(h)),e.push(l),e}function Yn(n,t){let e=[];for(let r of t.toSegments()){let s=Wt(r,n);for(let o of s)e.push(o)}return e}function ye(n,t){var e=[];if(n.box.not_intersect(t.box))return e;if(n.pc.equalTo(t.pc)&&i.Utils.EQ(n.r,t.r)){let a;return a=n.start,a.on(t)&&e.push(a),a=n.end,a.on(t)&&e.push(a),a=t.start,a.on(n)&&e.push(a),a=t.end,a.on(n)&&e.push(a),e}let r=new i.Circle(n.pc,n.r),s=new i.Circle(t.pc,t.r),o=r.intersect(s);for(let a of o)a.on(n)&&a.on(t)&&e.push(a);return e}function be(n,t){let e=[];if(n.box.not_intersect(t.box))return e;if(t.pc.equalTo(n.pc)&&i.Utils.EQ(t.r,n.r))return e.push(n.start),e.push(n.end),e;let r=t,s=new i.Circle(n.pc,n.r),o=Ke(r,s);for(let a of o)a.on(n)&&e.push(a);return e}function Jn(n,t){let e=[];for(let r of t.toSegments()){let s=K(r,n);for(let o of s)e.push(o)}return e}function Hn(n,t){return n.isSegment()?Tt(n.shape,t):K(t,n.shape)}function Xn(n,t){return n.isSegment()?K(n.shape,t):ye(n.shape,t)}function Ze(n,t){return n.isSegment()?qt(n.shape,t):_e(t,n.shape)}function Kn(n,t){return n.isSegment()?Wt(n.shape,t):be(n.shape,t)}function we(n,t){let e=[];for(let r of t.edges)for(let s of Hn(r,n))e.push(s);return e}function ve(n,t){let e=[];for(let r of t.edges)for(let s of Xn(r,n))e.push(s);return e}function Gt(n,t){let e=[];if(t.isEmpty())return e;for(let r of t.edges)for(let s of Ze(r,n))er(s,e)||e.push(s);return n.sortPoints(e)}function tr(n,t){let e=[];if(t.isEmpty())return e;for(let r of t.edges)for(let s of Kn(r,n))e.push(s);return e}function Zn(n,t){let e=n.shape,r=t.shape;return n.isSegment()?t.isSegment()?Tt(e,r):K(e,r):t.isSegment()?K(r,e):ye(e,r)}function ti(n,t){let e=[];if(t.isEmpty()||n.shape.box.not_intersect(t.box))return e;let r=t.edges.search(n.shape.box);for(let s of r)for(let o of Zn(n,s))e.push(o);return e}function ei(n,t){let e=[];if(n.isEmpty()||t.isEmpty()||n.box.not_intersect(t.box))return e;for(let r of n.edges)for(let s of ti(r,t))e.push(s);return e}function ri(n,t){return n instanceof i.Line?Gt(n,t):n instanceof i.Segment?we(n,t):n instanceof i.Arc?ve(n,t):[]}function er(n,t){return t.some(e=>e.equalTo(n))}var O=class extends Ut{constructor(...t){super();if(t.length!==0&&t.length==1&&t[0]instanceof Array){let e=t[0];if(e.length==0)return;let r=e.every(s=>s instanceof i.Segment||s instanceof i.Arc||s instanceof i.Ray||s instanceof i.Line);for(let s of e){let o=new i.Edge(s);this.append(o)}}}get edges(){return[...this]}get box(){return this.edges.reduce((t,e)=>t=t.merge(e.box),new i.Box)}get vertices(){let t=this.edges.map(e=>e.start);return t.push(this.last.end),t}clone(){return new O(this.toShapes())}addVertex(t,e){let r=e.shape.split(t);if(r[0]===null)return e.prev;if(r[1]===null)return e;let s=new i.Edge(r[0]),o=e.prev;return this.insert(s,o),e.shape=r[1],s}split(t){for(let e of t){let r=this.findEdgeByPoint(e);this.addVertex(e,r)}return this}findEdgeByPoint(t){let e;for(let r of this)if(r.shape.contains(t)){e=r;break}return e}translate(t){return new O(this.edges.map(e=>e.shape.translate(t)))}rotate(t=0,e=new i.Point){return new O(this.edges.map(r=>r.shape.rotate(t,e)))}transform(t=new i.Matrix){return new O(this.edges.map(e=>e.shape.transform(t)))}toShapes(){return this.edges.map(t=>t.shape.clone())}toJSON(){return this.edges.map(t=>t.toJSON())}svg(t={}){let{stroke:e,strokeWidth:r,fill:s,fillRule:o,fillOpacity:a,id:l,className:f}=t,u=l&&l.length>0?`id="${l}"`:"",h=f&&f.length>0?`class="${f}"`:"",c=`
<path stroke="${e||"black"}" stroke-width="${r||1}" fill="${s||"none"}" fill-opacity="${a||1}" ${u} ${h} d="`;c+=`
M${this.first.start.x},${this.first.start.y}`;for(let g of this)c+=g.svg();return c+=`" >
</path>`,c}};i.Multiline=O;var ni=(...n)=>new i.Multiline(...n);i.multiline=ni;function yt(n,t){let e,r=new i.Ray(t),s=new i.Line(r.pt,r.norm),o=new i.Box(r.box.xmin-i.DP_TOL,r.box.ymin-i.DP_TOL,r.box.xmax,r.box.ymax+i.DP_TOL);if(n.box.not_intersect(o))return i.OUTSIDE;let a=n.edges.search(o);if(a.length==0)return i.OUTSIDE;for(let u of a)if(u.shape.contains(t))return i.BOUNDARY;let l=[];for(let u of a)for(let h of r.intersect(u.shape)){if(h.equalTo(t))return i.BOUNDARY;l.push({pt:h,edge:u})}l.sort((u,h)=>Qe(u.pt.x,h.pt.x)?-1:ze(u.pt.x,h.pt.x)?1:0);let f=0;for(let u=0;u<l.length;u++){let h=l[u];if(h.pt.equalTo(h.edge.shape.start)){if(u>0&&h.pt.equalTo(l[u-1].pt)&&h.edge.prev===l[u-1].edge)continue;let c=h.edge.prev;for(;ae(c.length);)c=c.prev;let g=c.shape.tangentInEnd(),_=h.pt.translate(g),v=h.edge.shape.tangentInStart(),w=h.pt.translate(v),E=_.leftTo(s),b=w.leftTo(s);(E&&!b||!E&&b)&&f++}else if(h.pt.equalTo(h.edge.shape.end)){if(u>0&&h.pt.equalTo(l[u-1].pt)&&h.edge.next===l[u-1].edge)continue;let c=h.edge.next;for(;ae(c.length);)c=c.next;let g=c.shape.tangentInStart(),_=h.pt.translate(g),v=h.edge.shape.tangentInEnd(),w=h.pt.translate(v),E=_.leftTo(s),b=w.leftTo(s);(E&&!b||!E&&b)&&f++}else if(h.edge.shape instanceof i.Segment)f++;else{let c=h.edge.shape.box;H(h.pt.y,c.ymin)||H(h.pt.y,c.ymax)||f++}}return e=f%2==1?xt:We,e}function ii(n,t){return ft(n,t).equal()}function rr(n,t){return ft(n,t).intersect()}function si(n,t){return ft(n,t).touch()}function oi(n,t){return!rr(n,t)}function nr(n,t){return ft(n,t).inside()}function ir(n,t){return ft(n,t).covered()}function ai(n,t){return nr(t,n)}function sr(n,t){return ir(t,n)}function ft(n,t){if(n instanceof i.Line&&t instanceof i.Line)return li(n,t);if(n instanceof i.Line&&t instanceof i.Circle)return fi(n,t);if(n instanceof i.Line&&t instanceof i.Box)return ui(n,t);if(n instanceof i.Line&&t instanceof i.Polygon)return hi(n,t);if((n instanceof i.Segment||n instanceof i.Arc)&&t instanceof i.Polygon)return Ve(n,t);if((n instanceof i.Segment||n instanceof i.Arc)&&(t instanceof i.Circle||t instanceof i.Box))return Ve(n,new i.Polygon(t));if(n instanceof i.Polygon&&t instanceof i.Polygon)return Lt(n,t);if((n instanceof i.Circle||n instanceof i.Box)&&(t instanceof i.Circle||t instanceof i.Box))return Lt(new i.Polygon(n),new i.Polygon(t));if((n instanceof i.Circle||n instanceof i.Box)&&t instanceof i.Polygon)return Lt(new i.Polygon(n),t);if(n instanceof i.Polygon&&(t instanceof i.Circle||t instanceof i.Box))return Lt(n,new i.Polygon(t))}function li(n,t){let e=new Z,r=jt(n,t);return r.length===0?n.contains(t.pt)&&t.contains(n.pt)?(e.I2I=[n],e.I2E=[],e.E2I=[]):(e.I2I=[],e.I2E=[n],e.E2I=[t]):(e.I2I=r,e.I2E=n.split(r),e.E2I=t.split(r)),e}function fi(n,t){let e=new Z,r=lt(n,t);if(r.length===0)e.I2I=[],e.I2B=[],e.I2E=[n],e.E2I=[t];else if(r.length===1)e.I2I=[],e.I2B=r,e.I2E=n.split(r),e.E2I=[t];else{let s=new O([n]),o=n.sortPoints(r);s.split(o);let a=s.toShapes();e.I2I=[a[1]],e.I2B=o,e.I2E=[a[0],a[2]],e.E2I=new i.Polygon([t.toArc()]).cut(s)}return e}function ui(n,t){let e=new Z,r=wt(n,t);if(r.length===0)e.I2I=[],e.I2B=[],e.I2E=[n],e.E2I=[t];else if(r.length===1)e.I2I=[],e.I2B=r,e.I2E=n.split(r),e.E2I=[t];else{let s=new O([n]),o=n.sortPoints(r);s.split(o);let a=s.toShapes();t.toSegments().some(l=>l.contains(r[0])&&l.contains(r[1]))?(e.I2I=[],e.I2B=[a[1]],e.I2E=[a[0],a[2]],e.E2I=[t]):(e.I2I=[a[1]],e.I2B=o,e.I2E=[a[0],a[2]],e.E2I=new i.Polygon(t.toSegments()).cut(s))}return e}function hi(n,t){let e=new Z,r=Gt(n,t),s=new O([n]),o=r.length>0?r.slice():n.sortPoints(r);return s.split(o),[...s].forEach(a=>a.setInclusion(t)),e.I2I=[...s].filter(a=>a.bv===i.INSIDE).map(a=>a.shape),e.I2B=[...s].slice(1).map(a=>a.bv===i.BOUNDARY?a.shape:a.shape.start),e.I2E=[...s].filter(a=>a.bv===i.OUTSIDE).map(a=>a.shape),e.E2I=t.cut(s),e}function Ve(n,t){let e=new Z,r=ri(n,t),s=r.length>0?r.slice():n.sortPoints(r),o=new O([n]);o.split(s),[...o].forEach(a=>a.setInclusion(t)),e.I2I=[...o].filter(a=>a.bv===i.INSIDE).map(a=>a.shape),e.I2B=[...o].slice(1).map(a=>a.bv===i.BOUNDARY?a.shape:a.shape.start),e.I2E=[...o].filter(a=>a.bv===i.OUTSIDE).map(a=>a.shape),e.B2I=[],e.B2B=[],e.B2E=[];for(let a of[n.start,n.end])switch(yt(t,a)){case i.INSIDE:e.B2I.push(a);break;case i.BOUNDARY:e.B2B.push(a);break;case i.OUTSIDE:e.B2E.push(a);break;default:break}return e}function Lt(n,t){let e=new Z,[r,s]=He(n,t),o=Ye(n,t),a=ue(n,t),l=ue(t,n),[f,u]=Je(n,t),h=he(n,t),c=he(t,n);return e.I2I=o.isEmpty()?[]:[o],e.I2B=u,e.I2E=a.isEmpty()?[]:[a],e.B2I=f,e.B2B=r,e.B2E=h,e.E2I=l.isEmpty()?[]:[l],e.E2B=c,e}var ci=Object.freeze({equal:ii,intersect:rr,touch:si,disjoint:oi,inside:nr,covered:ir,contain:ai,cover:sr,relate:ft}),G=class{constructor(t=1,e=0,r=0,s=1,o=0,a=0){this.a=t,this.b=e,this.c=r,this.d=s,this.tx=o,this.ty=a}clone(){return new G(this.a,this.b,this.c,this.d,this.tx,this.ty)}transform(t){return[t[0]*this.a+t[1]*this.c+this.tx,t[0]*this.b+t[1]*this.d+this.ty]}multiply(t){return new G(this.a*t.a+this.c*t.b,this.b*t.a+this.d*t.b,this.a*t.c+this.c*t.d,this.b*t.c+this.d*t.d,this.a*t.tx+this.c*t.ty+this.tx,this.b*t.tx+this.d*t.ty+this.ty)}translate(...t){let e,r;if(t.length==1&&t[0]instanceof i.Vector)e=t[0].x,r=t[0].y;else if(t.length==2&&typeof t[0]=="number"&&typeof t[1]=="number")e=t[0],r=t[1];else throw i.Errors.ILLEGAL_PARAMETERS;return this.multiply(new G(1,0,0,1,e,r))}rotate(t){let e=Math.cos(t),r=Math.sin(t);return this.multiply(new G(e,r,-r,e,0,0))}scale(t,e){return this.multiply(new G(t,0,0,e,0,0))}equalTo(t){return!(!i.Utils.EQ(this.tx,t.tx)||!i.Utils.EQ(this.ty,t.ty)||!i.Utils.EQ(this.a,t.a)||!i.Utils.EQ(this.b,t.b)||!i.Utils.EQ(this.c,t.c)||!i.Utils.EQ(this.d,t.d))}};i.Matrix=G;var di=(...n)=>new i.Matrix(...n);i.matrix=di;var pi=class me{constructor(t,e){this.low=t,this.high=e}clone(){return new me(this.low,this.high)}get max(){return this.clone()}less_than(t){return this.low<t.low||this.low==t.low&&this.high<t.high}equal_to(t){return this.low==t.low&&this.high==t.high}intersect(t){return!this.not_intersect(t)}not_intersect(t){return this.high<t.low||t.high<this.low}merge(t){return new me(this.low===void 0?t.low:Math.min(this.low,t.low),this.high===void 0?t.high:Math.max(this.high,t.high))}output(){return[this.low,this.high]}static comparable_max(t,e){return t.merge(e)}static comparable_less_than(t,e){return t<e}},A=0,y=1,Q=class{constructor(t=void 0,e=void 0,r=null,s=null,o=null,a=y){this.left=r,this.right=s,this.parent=o,this.color=a,this.item={key:t,value:e},t&&t instanceof Array&&t.length==2&&!Number.isNaN(t[0])&&!Number.isNaN(t[1])&&(this.item.key=new pi(Math.min(t[0],t[1]),Math.max(t[0],t[1]))),this.max=this.item.key?this.item.key.max:void 0}isNil(){return this.item.key===void 0&&this.item.value===void 0&&this.left===null&&this.right===null&&this.color===y}less_than(t){if(this.item.value===this.item.key&&t.item.value===t.item.key)return this.item.key.less_than(t.item.key);{let e=this.item.value&&t.item.value&&this.item.value.less_than?this.item.value.less_than(t.item.value):this.item.value<t.item.value;return this.item.key.less_than(t.item.key)||this.item.key.equal_to(t.item.key)&&e}}equal_to(t){if(this.item.value===this.item.key&&t.item.value===t.item.key)return this.item.key.equal_to(t.item.key);{let e=this.item.value&&t.item.value&&this.item.value.equal_to?this.item.value.equal_to(t.item.value):this.item.value==t.item.value;return this.item.key.equal_to(t.item.key)&&e}}intersect(t){return this.item.key.intersect(t.item.key)}copy_data(t){this.item.key=t.item.key.clone(),this.item.value=t.item.value&&t.item.value.clone?t.item.value.clone():t.item.value}update_max(){if(this.max=this.item.key?this.item.key.max:void 0,this.right&&this.right.max){let t=this.item.key.constructor.comparable_max;this.max=t(this.max,this.right.max)}if(this.left&&this.left.max){let t=this.item.key.constructor.comparable_max;this.max=t(this.max,this.left.max)}}not_intersect_left_subtree(t){let e=this.item.key.constructor.comparable_less_than,r=this.left.max.high!==void 0?this.left.max.high:this.left.max;return e(r,t.item.key.low)}not_intersect_right_subtree(t){let e=this.item.key.constructor.comparable_less_than,r=this.right.max.low!==void 0?this.right.max.low:this.right.item.key.low;return e(t.item.key.high,r)}},at=class{constructor(){this.root=null,this.nil_node=new Q}get size(){let t=0;return this.tree_walk(this.root,()=>t++),t}get keys(){let t=[];return this.tree_walk(this.root,e=>t.push(e.item.key.output?e.item.key.output():e.item.key)),t}get values(){let t=[];return this.tree_walk(this.root,e=>t.push(e.item.value)),t}get items(){let t=[];return this.tree_walk(this.root,e=>t.push({key:e.item.key.output?e.item.key.output():e.item.key,value:e.item.value})),t}isEmpty(){return this.root==null||this.root==this.nil_node}insert(t,e=t){if(t===void 0)return;let r=new Q(t,e,this.nil_node,this.nil_node,null,A);return this.tree_insert(r),this.recalc_max(r),r}exist(t,e=t){let r=new Q(t,e);return!!this.tree_search(this.root,r)}remove(t,e=t){let r=new Q(t,e),s=this.tree_search(this.root,r);return s&&this.tree_delete(s),s}search(t,e=(r,s)=>r===s?s.output():r){let r=new Q(t),s=[];return this.tree_search_interval(this.root,r,s),s.map(o=>e(o.item.value,o.item.key))}intersect_any(t){let e=new Q(t);return this.tree_find_any_interval(this.root,e)}forEach(t){this.tree_walk(this.root,e=>t(e.item.key,e.item.value))}map(t){let e=new at;return this.tree_walk(this.root,r=>e.insert(r.item.key,t(r.item.value,r.item.key))),e}recalc_max(t){let e=t;for(;e.parent!=null;)e.parent.update_max(),e=e.parent}tree_insert(t){let e=this.root,r=null;if(this.root==null||this.root==this.nil_node)this.root=t;else{for(;e!=this.nil_node;)r=e,t.less_than(e)?e=e.left:e=e.right;t.parent=r,t.less_than(r)?r.left=t:r.right=t}this.insert_fixup(t)}insert_fixup(t){let e,r;for(e=t;e!=this.root&&e.parent.color==A;)e.parent==e.parent.parent.left?(r=e.parent.parent.right,r.color==A?(e.parent.color=y,r.color=y,e.parent.parent.color=A,e=e.parent.parent):(e==e.parent.right&&(e=e.parent,this.rotate_left(e)),e.parent.color=y,e.parent.parent.color=A,this.rotate_right(e.parent.parent))):(r=e.parent.parent.left,r.color==A?(e.parent.color=y,r.color=y,e.parent.parent.color=A,e=e.parent.parent):(e==e.parent.left&&(e=e.parent,this.rotate_right(e)),e.parent.color=y,e.parent.parent.color=A,this.rotate_left(e.parent.parent)));this.root.color=y}tree_delete(t){let e,r;t.left==this.nil_node||t.right==this.nil_node?e=t:e=this.tree_successor(t),e.left!=this.nil_node?r=e.left:r=e.right,r.parent=e.parent,e==this.root?this.root=r:(e==e.parent.left?e.parent.left=r:e.parent.right=r,e.parent.update_max()),this.recalc_max(r),e!=t&&(t.copy_data(e),t.update_max(),this.recalc_max(t)),e.color==y&&this.delete_fixup(r)}delete_fixup(t){let e=t,r;for(;e!=this.root&&e.parent!=null&&e.color==y;)e==e.parent.left?(r=e.parent.right,r.color==A&&(r.color=y,e.parent.color=A,this.rotate_left(e.parent),r=e.parent.right),r.left.color==y&&r.right.color==y?(r.color=A,e=e.parent):(r.right.color==y&&(r.color=A,r.left.color=y,this.rotate_right(r),r=e.parent.right),r.color=e.parent.color,e.parent.color=y,r.right.color=y,this.rotate_left(e.parent),e=this.root)):(r=e.parent.left,r.color==A&&(r.color=y,e.parent.color=A,this.rotate_right(e.parent),r=e.parent.left),r.left.color==y&&r.right.color==y?(r.color=A,e=e.parent):(r.left.color==y&&(r.color=A,r.right.color=y,this.rotate_left(r),r=e.parent.left),r.color=e.parent.color,e.parent.color=y,r.left.color=y,this.rotate_right(e.parent),e=this.root));e.color=y}tree_search(t,e){if(!(t==null||t==this.nil_node))return e.equal_to(t)?t:e.less_than(t)?this.tree_search(t.left,e):this.tree_search(t.right,e)}tree_search_interval(t,e,r){t!=null&&t!=this.nil_node&&(t.left!=this.nil_node&&!t.not_intersect_left_subtree(e)&&this.tree_search_interval(t.left,e,r),t.intersect(e)&&r.push(t),t.right!=this.nil_node&&!t.not_intersect_right_subtree(e)&&this.tree_search_interval(t.right,e,r))}tree_find_any_interval(t,e){let r=!1;return t!=null&&t!=this.nil_node&&(t.left!=this.nil_node&&!t.not_intersect_left_subtree(e)&&(r=this.tree_find_any_interval(t.left,e)),r||(r=t.intersect(e)),!r&&t.right!=this.nil_node&&!t.not_intersect_right_subtree(e)&&(r=this.tree_find_any_interval(t.right,e))),r}local_minimum(t){let e=t;for(;e.left!=null&&e.left!=this.nil_node;)e=e.left;return e}local_maximum(t){let e=t;for(;e.right!=null&&e.right!=this.nil_node;)e=e.right;return e}tree_successor(t){let e,r,s;if(t.right!=this.nil_node)e=this.local_minimum(t.right);else{for(r=t,s=t.parent;s!=null&&s.right==r;)r=s,s=s.parent;e=s}return e}rotate_left(t){let e=t.right;t.right=e.left,e.left!=this.nil_node&&(e.left.parent=t),e.parent=t.parent,t==this.root?this.root=e:t==t.parent.left?t.parent.left=e:t.parent.right=e,e.left=t,t.parent=e,t!=null&&t!=this.nil_node&&t.update_max(),e=t.parent,e!=null&&e!=this.nil_node&&e.update_max()}rotate_right(t){let e=t.left;t.left=e.right,e.right!=this.nil_node&&(e.right.parent=t),e.parent=t.parent,t==this.root?this.root=e:t==t.parent.left?t.parent.left=e:t.parent.right=e,e.right=t,t.parent=e,t!=null&&t!=this.nil_node&&t.update_max(),e=t.parent,e!=null&&e!=this.nil_node&&e.update_max()}tree_walk(t,e){t!=null&&t!=this.nil_node&&(this.tree_walk(t.left,e),e(t),this.tree_walk(t.right,e))}testRedBlackProperty(){let t=!0;return this.tree_walk(this.root,function(e){e.color==A&&(e.left.color==y&&e.right.color==y||(t=!1))}),t}testBlackHeightProperty(t){let e=0,r=0,s=0;if(t.color==y&&e++,t.left!=this.nil_node?r=this.testBlackHeightProperty(t.left):r=1,t.right!=this.nil_node?s=this.testBlackHeightProperty(t.right):s=1,r!=s)throw new Error("Red-black height property violated");return e+=r,e}},or=class extends Set{constructor(t){super(t);this.index=new at,this.forEach(e=>this.index.insert(e))}add(t){let e=this.size;if(super.add(t),this.size>e){let r=this.index.insert(t.box,t)}return this}delete(t){let e=super.delete(t);return e&&this.index.remove(t.box,t),e}clear(){super.clear(),this.index=new at}search(t){return this.index.search(t)}hit(t){let e=new i.Box(t.x-1,t.y-1,t.x+1,t.y+1);return this.index.search(e).filter(s=>t.on(s))}svg(){return[...this].reduce((e,r)=>e+r.svg(),"")}};i.PlanarSet=or;var Dt=class{constructor(...t){if(this.x=0,this.y=0,t.length!==0){if(t.length===1&&t[0]instanceof Array&&t[0].length===2){let e=t[0];if(typeof e[0]=="number"&&typeof e[1]=="number"){this.x=e[0],this.y=e[1];return}}if(t.length===1&&t[0]instanceof Object&&t[0].name==="point"){let{x:e,y:r}=t[0];this.x=e,this.y=r;return}if(t.length===2&&typeof t[0]=="number"&&typeof t[1]=="number"){this.x=t[0],this.y=t[1];return}throw i.Errors.ILLEGAL_PARAMETERS}}get box(){return new i.Box(this.x,this.y,this.x,this.y)}clone(){return new i.Point(this.x,this.y)}get vertices(){return[this.clone()]}equalTo(t){return i.Utils.EQ(this.x,t.x)&&i.Utils.EQ(this.y,t.y)}lessThan(t){return!!(i.Utils.LT(this.y,t.y)||i.Utils.EQ(this.y,t.y)&&i.Utils.LT(this.x,t.x))}rotate(t,e={x:0,y:0}){var r=e.x+(this.x-e.x)*Math.cos(t)-(this.y-e.y)*Math.sin(t),s=e.y+(this.x-e.x)*Math.sin(t)+(this.y-e.y)*Math.cos(t);return new i.Point(r,s)}translate(...t){if(t.length==1&&(t[0]instanceof i.Vector||!isNaN(t[0].x)&&!isNaN(t[0].y)))return new i.Point(this.x+t[0].x,this.y+t[0].y);if(t.length==2&&typeof t[0]=="number"&&typeof t[1]=="number")return new i.Point(this.x+t[0],this.y+t[1]);throw i.Errors.ILLEGAL_PARAMETERS}transform(t){return new i.Point(t.transform([this.x,this.y]))}projectionOn(t){if(this.equalTo(t.pt))return this.clone();let e=new i.Vector(this,t.pt);if(i.Utils.EQ_0(e.cross(t.norm)))return t.pt.clone();let r=e.dot(t.norm),s=t.norm.multiply(r);return this.translate(s)}leftTo(t){let e=new i.Vector(t.pt,this);return i.Utils.GT(e.dot(t.norm),0)}distanceTo(t){if(t instanceof Dt){let e=t.x-this.x,r=t.y-this.y;return[Math.sqrt(e*e+r*r),new i.Segment(this,t)]}if(t instanceof i.Line)return i.Distance.point2line(this,t);if(t instanceof i.Circle)return i.Distance.point2circle(this,t);if(t instanceof i.Segment)return i.Distance.point2segment(this,t);if(t instanceof i.Arc)return i.Distance.point2arc(this,t);if(t instanceof i.Polygon)return i.Distance.point2polygon(this,t);if(t instanceof i.PlanarSet)return i.Distance.shape2planarSet(this,t)}on(t){if(t instanceof i.Point)return this.equalTo(t);if(t instanceof i.Line)return t.contains(this);if(t instanceof i.Circle)return t.contains(this);if(t instanceof i.Segment)return t.contains(this);if(t instanceof i.Arc)return t.contains(this);if(t instanceof i.Polygon)return t.contains(this)}toJSON(){return Object.assign({},this,{name:"point"})}svg(t={}){let{r:e,stroke:r,strokeWidth:s,fill:o,id:a,className:l}=t,f=a&&a.length>0?`id="${a}"`:"",u=l&&l.length>0?`class="${l}"`:"";return`
<circle cx="${this.x}" cy="${this.y}" r="${e||3}" stroke="${r||"black"}" stroke-width="${s||1}" fill="${o||"red"}" ${f} ${u} />`}};i.Point=Dt;var mi=(...n)=>new i.Point(...n);i.point=mi;var ar=class{constructor(...t){if(this.x=0,this.y=0,t.length!==0){if(t.length===1&&t[0]instanceof Array&&t[0].length===2){let e=t[0];if(typeof e[0]=="number"&&typeof e[1]=="number"){this.x=e[0],this.y=e[1];return}}if(t.length===1&&t[0]instanceof Object&&t[0].name==="vector"){let{x:e,y:r}=t[0];this.x=e,this.y=r;return}if(t.length===2){let e=t[0],r=t[1];if(typeof e=="number"&&typeof r=="number"){this.x=e,this.y=r;return}if(e instanceof i.Point&&r instanceof i.Point){this.x=r.x-e.x,this.y=r.y-e.y;return}}throw i.Errors.ILLEGAL_PARAMETERS}}clone(){return new i.Vector(this.x,this.y)}get slope(){let t=Math.atan2(this.y,this.x);return t<0&&(t=2*Math.PI+t),t}get length(){return Math.sqrt(this.dot(this))}equalTo(t){return i.Utils.EQ(this.x,t.x)&&i.Utils.EQ(this.y,t.y)}multiply(t){return new i.Vector(t*this.x,t*this.y)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}normalize(){if(!i.Utils.EQ_0(this.length))return new i.Vector(this.x/this.length,this.y/this.length);throw i.Errors.ZERO_DIVISION}rotate(t){let r=new i.Point(this.x,this.y).rotate(t);return new i.Vector(r.x,r.y)}rotate90CCW(){return new i.Vector(-this.y,this.x)}rotate90CW(){return new i.Vector(this.y,-this.x)}invert(){return new i.Vector(-this.x,-this.y)}add(t){return new i.Vector(this.x+t.x,this.y+t.y)}subtract(t){return new i.Vector(this.x-t.x,this.y-t.y)}angleTo(t){let e=this.normalize(),r=t.normalize(),s=Math.atan2(e.cross(r),e.dot(r));return s<0&&(s+=2*Math.PI),s}projectionOn(t){let e=t.normalize(),r=this.dot(e);return e.multiply(r)}toJSON(){return Object.assign({},this,{name:"vector"})}};i.Vector=ar;var gi=(...n)=>new i.Vector(...n);i.vector=gi;var rt=class{constructor(...t){if(this.ps=new i.Point,this.pe=new i.Point,t.length!==0){if(t.length===1&&t[0]instanceof Array&&t[0].length===4){let e=t[0];this.ps=new i.Point(e[0],e[1]),this.pe=new i.Point(e[2],e[3]);return}if(t.length===1&&t[0]instanceof Object&&t[0].name==="segment"){let{ps:e,pe:r}=t[0];this.ps=new i.Point(e.x,e.y),this.pe=new i.Point(r.x,r.y);return}if(t.length===1&&t[0]instanceof i.Point){this.ps=t[0].clone();return}if(t.length===2&&t[0]instanceof i.Point&&t[1]instanceof i.Point){this.ps=t[0].clone(),this.pe=t[1].clone();return}if(t.length===4){this.ps=new i.Point(t[0],t[1]),this.pe=new i.Point(t[2],t[3]);return}throw i.Errors.ILLEGAL_PARAMETERS}}clone(){return new i.Segment(this.start,this.end)}get start(){return this.ps}get end(){return this.pe}get vertices(){return[this.ps.clone(),this.pe.clone()]}get length(){return this.start.distanceTo(this.end)[0]}get slope(){return new i.Vector(this.start,this.end).slope}get box(){return new i.Box(Math.min(this.start.x,this.end.x),Math.min(this.start.y,this.end.y),Math.max(this.start.x,this.end.x),Math.max(this.start.y,this.end.y))}equalTo(t){return this.ps.equalTo(t.ps)&&this.pe.equalTo(t.pe)}contains(t){return i.Utils.EQ_0(this.distanceToPoint(t))}intersect(t){if(t instanceof i.Point)return this.contains(t)?[t]:[];if(t instanceof i.Line)return qt(this,t);if(t instanceof i.Segment)return Tt(this,t);if(t instanceof i.Circle)return Wt(this,t);if(t instanceof i.Box)return Qn(this,t);if(t instanceof i.Arc)return K(this,t);if(t instanceof i.Polygon)return we(this,t)}distanceTo(t){if(t instanceof i.Point){let[e,r]=i.Distance.point2segment(t,this);return r=r.reverse(),[e,r]}if(t instanceof i.Circle){let[e,r]=i.Distance.segment2circle(this,t);return[e,r]}if(t instanceof i.Line){let[e,r]=i.Distance.segment2line(this,t);return[e,r]}if(t instanceof i.Segment){let[e,r]=i.Distance.segment2segment(this,t);return[e,r]}if(t instanceof i.Arc){let[e,r]=i.Distance.segment2arc(this,t);return[e,r]}if(t instanceof i.Polygon){let[e,r]=i.Distance.shape2polygon(this,t);return[e,r]}if(t instanceof i.PlanarSet){let[e,r]=i.Distance.shape2planarSet(this,t);return[e,r]}}tangentInStart(){return new i.Vector(this.start,this.end).normalize()}tangentInEnd(){return new i.Vector(this.end,this.start).normalize()}reverse(){return new rt(this.end,this.start)}split(t){return this.start.equalTo(t)?[null,this.clone()]:this.end.equalTo(t)?[this.clone(),null]:[new i.Segment(this.start,t),new i.Segment(t,this.end)]}middle(){return new i.Point((this.start.x+this.end.x)/2,(this.start.y+this.end.y)/2)}pointAtLength(t){if(t>this.length||t<0)return null;if(t==0)return this.start;if(t==this.length)return this.end;let e=t/this.length;return new i.Point((this.end.x-this.start.x)*e+this.start.x,(this.end.y-this.start.y)*e+this.start.y)}distanceToPoint(t){let[e,...r]=i.Distance.point2segment(t,this);return e}definiteIntegral(t=0){let e=this.end.x-this.start.x,r=this.start.y-t,s=this.end.y-t;return e*(r+s)/2}translate(...t){return new rt(this.ps.translate(...t),this.pe.translate(...t))}rotate(t=0,e=new i.Point){let r=new i.Matrix;return r=r.translate(e.x,e.y).rotate(t).translate(-e.x,-e.y),this.transform(r)}transform(t=new i.Matrix){return new rt(this.ps.transform(t),this.pe.transform(t))}isZeroLength(){return this.ps.equalTo(this.pe)}sortPoints(t){return new i.Line(this.start,this.end).sortPoints(t)}toJSON(){return Object.assign({},this,{name:"segment"})}svg(t={}){let{stroke:e,strokeWidth:r,id:s,className:o}=t,a=s&&s.length>0?`id="${s}"`:"",l=o&&o.length>0?`class="${o}"`:"";return`
<line x1="${this.start.x}" y1="${this.start.y}" x2="${this.end.x}" y2="${this.end.y}" stroke="${e||"black"}" stroke-width="${r||1}" ${a} ${l} />`}};i.Segment=rt;var xi=(...n)=>new i.Segment(...n);i.segment=xi;var{vector:Bt}=i,zt=class{constructor(...t){if(this.pt=new i.Point,this.norm=new i.Vector(0,1),t.length!=0){if(t.length==1&&t[0]instanceof Object&&t[0].name==="line"){let{pt:e,norm:r}=t[0];this.pt=new i.Point(e),this.norm=new i.Vector(r);return}if(t.length==2){let e=t[0],r=t[1];if(e instanceof i.Point&&r instanceof i.Point){this.pt=e,this.norm=zt.points2norm(e,r),this.norm.dot(Bt(this.pt.x,this.pt.y))>=0&&this.norm.invert();return}if(e instanceof i.Point&&r instanceof i.Vector){if(i.Utils.EQ_0(r.x)&&i.Utils.EQ_0(r.y))throw i.Errors.ILLEGAL_PARAMETERS;this.pt=e.clone(),this.norm=r.clone(),this.norm=this.norm.normalize(),this.norm.dot(Bt(this.pt.x,this.pt.y))>=0&&this.norm.invert();return}if(e instanceof i.Vector&&r instanceof i.Point){if(i.Utils.EQ_0(e.x)&&i.Utils.EQ_0(e.y))throw i.Errors.ILLEGAL_PARAMETERS;this.pt=r.clone(),this.norm=e.clone(),this.norm=this.norm.normalize(),this.norm.dot(Bt(this.pt.x,this.pt.y))>=0&&this.norm.invert();return}}throw i.Errors.ILLEGAL_PARAMETERS}}clone(){return new i.Line(this.pt,this.norm)}get start(){}get end(){}get length(){return Number.POSITIVE_INFINITY}get box(){return new i.Box(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY)}get middle(){}get slope(){return new i.Vector(this.norm.y,-this.norm.x).slope}get standard(){let t=this.norm.x,e=this.norm.y,r=this.norm.dot(this.pt);return[t,e,r]}parallelTo(t){return i.Utils.EQ_0(this.norm.cross(t.norm))}incidentTo(t){return this.parallelTo(t)&&this.pt.on(t)}contains(t){if(this.pt.equalTo(t))return!0;let e=new i.Vector(this.pt,t);return i.Utils.EQ_0(this.norm.dot(e))}coord(t){return Bt(t.x,t.y).cross(this.norm)}intersect(t){if(t instanceof i.Point)return this.contains(t)?[t]:[];if(t instanceof i.Line)return jt(this,t);if(t instanceof i.Circle)return lt(this,t);if(t instanceof i.Box)return wt(this,t);if(t instanceof i.Segment)return qt(t,this);if(t instanceof i.Arc)return _e(this,t);if(t instanceof i.Polygon)return Gt(this,t)}distanceTo(t){if(t instanceof i.Point){let[e,r]=i.Distance.point2line(t,this);return r=r.reverse(),[e,r]}if(t instanceof i.Circle){let[e,r]=i.Distance.circle2line(t,this);return r=r.reverse(),[e,r]}if(t instanceof i.Segment){let[e,r]=i.Distance.segment2line(t,this);return[e,r.reverse()]}if(t instanceof i.Arc){let[e,r]=i.Distance.arc2line(t,this);return[e,r.reverse()]}if(t instanceof i.Polygon){let[e,r]=i.Distance.shape2polygon(this,t);return[e,r]}}split(t){if(t instanceof i.Point)return[new i.Ray(t,this.norm.invert()),new i.Ray(t,this.norm)];{let e=new i.Multiline([this]),r=this.sortPoints(t);return e.split(r),e.toShapes()}}sortPoints(t){return t.slice().sort((e,r)=>this.coord(e)<this.coord(r)?-1:this.coord(e)>this.coord(r)?1:0)}toJSON(){return Object.assign({},this,{name:"line"})}svg(t,e={}){let r=wt(this,t);if(r.length===0)return"";let s=r[0],o=r.length==2?r[1]:r.find(l=>!l.equalTo(s));return o===void 0&&(o=s),new i.Segment(s,o).svg(e)}static points2norm(t,e){if(t.equalTo(e))throw i.Errors.ILLEGAL_PARAMETERS;return new i.Vector(t,e).normalize().rotate90CCW()}};i.Line=zt;var _i=(...n)=>new i.Line(...n);i.line=_i;var lr=class{constructor(...t){if(this.pc=new i.Point,this.r=1,t.length==1&&t[0]instanceof Object&&t[0].name==="circle"){let{pc:e,r}=t[0];this.pc=new i.Point(e),this.r=r;return}else{let[e,r]=[...t];e&&e instanceof i.Point&&(this.pc=e.clone()),r!==void 0&&(this.r=r);return}throw i.Errors.ILLEGAL_PARAMETERS}clone(){return new i.Circle(this.pc.clone(),this.r)}get center(){return this.pc}get box(){return new i.Box(this.pc.x-this.r,this.pc.y-this.r,this.pc.x+this.r,this.pc.y+this.r)}contains(t){if(t instanceof i.Point)return i.Utils.LE(t.distanceTo(this.center)[0],this.r);if(t instanceof i.Segment)return i.Utils.LE(t.start.distanceTo(this.center)[0],this.r)&&i.Utils.LE(t.end.distanceTo(this.center)[0],this.r);if(t instanceof i.Arc)return this.intersect(t).length===0&&i.Utils.LE(t.start.distanceTo(this.center)[0],this.r)&&i.Utils.LE(t.end.distanceTo(this.center)[0],this.r);if(t instanceof i.Circle)return this.intersect(t).length===0&&i.Utils.LE(t.r,this.r)&&i.Utils.LE(t.center.distanceTo(this.center)[0],this.r)}toArc(t=!0){return new i.Arc(this.center,this.r,Math.PI,-Math.PI,t)}intersect(t){if(t instanceof i.Point)return this.contains(t)?[t]:[];if(t instanceof i.Line)return lt(t,this);if(t instanceof i.Segment)return Wt(t,this);if(t instanceof i.Circle)return Ke(t,this);if(t instanceof i.Box)return Yn(this,t);if(t instanceof i.Arc)return be(t,this);if(t instanceof i.Polygon)return tr(this,t)}distanceTo(t){if(t instanceof i.Point){let[e,r]=i.Distance.point2circle(t,this);return r=r.reverse(),[e,r]}if(t instanceof i.Circle){let[e,r]=i.Distance.circle2circle(this,t);return[e,r]}if(t instanceof i.Line){let[e,r]=i.Distance.circle2line(this,t);return[e,r]}if(t instanceof i.Segment){let[e,r]=i.Distance.segment2circle(t,this);return r=r.reverse(),[e,r]}if(t instanceof i.Arc){let[e,r]=i.Distance.arc2circle(t,this);return r=r.reverse(),[e,r]}if(t instanceof i.Polygon){let[e,r]=i.Distance.shape2polygon(this,t);return[e,r]}if(t instanceof i.PlanarSet){let[e,r]=i.Distance.shape2planarSet(this,t);return[e,r]}}toJSON(){return Object.assign({},this,{name:"circle"})}svg(t={}){let{stroke:e,strokeWidth:r,fill:s,fillOpacity:o,id:a,className:l}=t,f=a&&a.length>0?`id="${a}"`:"",u=l&&l.length>0?`class="${l}"`:"";return`
<circle cx="${this.pc.x}" cy="${this.pc.y}" r="${this.r}" stroke="${e||"black"}" stroke-width="${r||1}" fill="${s||"none"}" fill-opacity="${o||1}" ${f} ${u} />`}};i.Circle=lr;var yi=(...n)=>new i.Circle(...n);i.circle=yi;var fr=class{constructor(...t){if(this.pc=new i.Point,this.r=1,this.startAngle=0,this.endAngle=2*Math.PI,this.counterClockwise=i.CCW,t.length!=0){if(t.length==1&&t[0]instanceof Object&&t[0].name==="arc"){let{pc:e,r,startAngle:s,endAngle:o,counterClockwise:a}=t[0];this.pc=new i.Point(e.x,e.y),this.r=r,this.startAngle=s,this.endAngle=o,this.counterClockwise=a;return}else{let[e,r,s,o,a]=[...t];e&&e instanceof i.Point&&(this.pc=e.clone()),r!==void 0&&(this.r=r),s!==void 0&&(this.startAngle=s),o!==void 0&&(this.endAngle=o),a!==void 0&&(this.counterClockwise=a);return}throw i.Errors.ILLEGAL_PARAMETERS}}clone(){return new i.Arc(this.pc.clone(),this.r,this.startAngle,this.endAngle,this.counterClockwise)}get sweep(){if(i.Utils.EQ(this.startAngle,this.endAngle))return 0;if(i.Utils.EQ(Math.abs(this.startAngle-this.endAngle),i.PIx2))return i.PIx2;let t;return this.counterClockwise?t=i.Utils.GT(this.endAngle,this.startAngle)?this.endAngle-this.startAngle:this.endAngle-this.startAngle+i.PIx2:t=i.Utils.GT(this.startAngle,this.endAngle)?this.startAngle-this.endAngle:this.startAngle-this.endAngle+i.PIx2,i.Utils.GT(t,i.PIx2)&&(t-=i.PIx2),i.Utils.LT(t,0)&&(t+=i.PIx2),t}get start(){return new i.Point(this.pc.x+this.r,this.pc.y).rotate(this.startAngle,this.pc)}get end(){return new i.Point(this.pc.x+this.r,this.pc.y).rotate(this.endAngle,this.pc)}get center(){return this.pc.clone()}get vertices(){return[this.start.clone(),this.end.clone()]}get length(){return Math.abs(this.sweep*this.r)}get box(){let e=this.breakToFunctional().reduce((r,s)=>r.merge(s.start.box),new i.Box);return e=e.merge(this.end.box),e}contains(t){if(!i.Utils.EQ(this.pc.distanceTo(t)[0],this.r))return!1;if(t.equalTo(this.start))return!0;let e=new i.Vector(this.pc,t).slope,r=new i.Arc(this.pc,this.r,this.startAngle,e,this.counterClockwise);return i.Utils.LE(r.length,this.length)}split(t){if(this.start.equalTo(t))return[null,this.clone()];if(this.end.equalTo(t))return[this.clone(),null];let e=new i.Vector(this.pc,t).slope;return[new i.Arc(this.pc,this.r,this.startAngle,e,this.counterClockwise),new i.Arc(this.pc,this.r,e,this.endAngle,this.counterClockwise)]}middle(){let t=this.counterClockwise?this.startAngle+this.sweep/2:this.startAngle-this.sweep/2;return new i.Arc(this.pc,this.r,this.startAngle,t,this.counterClockwise).end}pointAtLength(t){if(t>this.length||t<0)return null;if(t==0)return this.start;if(t==this.length)return this.end;let e=t/this.length,r=this.counterClockwise?this.startAngle+this.sweep*e:this.startAngle-this.sweep*e;return new i.Arc(this.pc,this.r,this.startAngle,r,this.counterClockwise).end}chordHeight(){return(1-Math.cos(Math.abs(this.sweep/2)))*this.r}intersect(t){if(t instanceof i.Point)return this.contains(t)?[t]:[];if(t instanceof i.Line)return _e(t,this);if(t instanceof i.Circle)return be(this,t);if(t instanceof i.Segment)return K(t,this);if(t instanceof i.Box)return Jn(this,t);if(t instanceof i.Arc)return ye(this,t);if(t instanceof i.Polygon)return ve(this,t)}distanceTo(t){if(t instanceof i.Point){let[e,r]=i.Distance.point2arc(t,this);return r=r.reverse(),[e,r]}if(t instanceof i.Circle){let[e,r]=i.Distance.arc2circle(this,t);return[e,r]}if(t instanceof i.Line){let[e,r]=i.Distance.arc2line(this,t);return[e,r]}if(t instanceof i.Segment){let[e,r]=i.Distance.segment2arc(t,this);return r=r.reverse(),[e,r]}if(t instanceof i.Arc){let[e,r]=i.Distance.arc2arc(this,t);return[e,r]}if(t instanceof i.Polygon){let[e,r]=i.Distance.shape2polygon(this,t);return[e,r]}if(t instanceof i.PlanarSet){let[e,r]=i.Distance.shape2planarSet(this,t);return[e,r]}}breakToFunctional(){let t=[],e=[0,Math.PI/2,2*Math.PI/2,3*Math.PI/2],r=[this.pc.translate(this.r,0),this.pc.translate(0,this.r),this.pc.translate(-this.r,0),this.pc.translate(0,-this.r)],s=[];for(let o=0;o<4;o++)r[o].on(this)&&s.push(new i.Arc(this.pc,this.r,this.startAngle,e[o],this.counterClockwise));if(s.length==0)t.push(this.clone());else{s.sort((l,f)=>l.length-f.length);for(let l=0;l<s.length;l++){let f=t.length>0?t[t.length-1]:void 0,u;f?u=new i.Arc(this.pc,this.r,f.endAngle,s[l].endAngle,this.counterClockwise):u=new i.Arc(this.pc,this.r,this.startAngle,s[l].endAngle,this.counterClockwise),i.Utils.EQ_0(u.length)||t.push(u.clone())}let o=t.length>0?t[t.length-1]:void 0,a;o?a=new i.Arc(this.pc,this.r,o.endAngle,this.endAngle,this.counterClockwise):a=new i.Arc(this.pc,this.r,this.startAngle,this.endAngle,this.counterClockwise),!i.Utils.EQ_0(a.length)&&!i.Utils.EQ(a.sweep,2*Math.PI)&&t.push(a.clone())}return t}tangentInStart(){let t=new i.Vector(this.pc,this.start),e=this.counterClockwise?Math.PI/2:-Math.PI/2;return t.rotate(e).normalize()}tangentInEnd(){let t=new i.Vector(this.pc,this.end),e=this.counterClockwise?-Math.PI/2:Math.PI/2;return t.rotate(e).normalize()}reverse(){return new i.Arc(this.pc,this.r,this.endAngle,this.startAngle,!this.counterClockwise)}translate(...t){let e=this.clone();return e.pc=this.pc.translate(...t),e}rotate(t=0,e=new i.Point){let r=new i.Matrix;return r=r.translate(e.x,e.y).rotate(t).translate(-e.x,-e.y),this.transform(r)}scale(t=1,e=1){let r=new i.Matrix;return r=r.scale(t,e),this.transform(r)}transform(t=new i.Matrix){let e=this.start.transform(t),r=this.end.transform(t),s=this.pc.transform(t),o=this.counterClockwise;return t.a*t.d<0&&(o=!o),i.Arc.arcSE(s,e,r,o)}static arcSE(t,e,r,s){let{vector:o}=i,a=o(t,e).slope,l=o(t,r).slope;i.Utils.EQ(a,l)&&(l+=2*Math.PI,s=!0);let f=o(t,e).length;return new i.Arc(t,f,a,l,s)}definiteIntegral(t=0){return this.breakToFunctional().reduce((s,o)=>s+o.circularSegmentDefiniteIntegral(t),0)}circularSegmentDefiniteIntegral(t){let e=new i.Line(this.start,this.end),r=this.pc.leftTo(e),o=new i.Segment(this.start,this.end).definiteIntegral(t),a=this.circularSegmentArea();return r?o-a:o+a}circularSegmentArea(){return .5*this.r*this.r*(this.sweep-Math.sin(this.sweep))}sortPoints(t){let{vector:e}=i;return t.slice().sort((r,s)=>{let o=e(this.pc,r).slope,a=e(this.pc,s).slope;return o<a?-1:o>a?1:0})}toJSON(){return Object.assign({},this,{name:"arc"})}svg(t={}){let e=this.sweep<=Math.PI?"0":"1",r=this.counterClockwise?"1":"0",{stroke:s,strokeWidth:o,fill:a,id:l,className:f}=t,u=l&&l.length>0?`id="${l}"`:"",h=f&&f.length>0?`class="${f}"`:"";return i.Utils.EQ(this.sweep,2*Math.PI)?new i.Circle(this.pc,this.r).svg(t):`
<path d="M${this.start.x},${this.start.y}
                             A${this.r},${this.r} 0 ${e},${r} ${this.end.x},${this.end.y}"
                    stroke="${s||"black"}" stroke-width="${o||1}" fill="${a||"none"}" ${u} ${h} />`}};i.Arc=fr;var bi=(...n)=>new i.Arc(...n);i.arc=bi;var vt=class{constructor(t=void 0,e=void 0,r=void 0,s=void 0){this.xmin=t,this.ymin=e,this.xmax=r,this.ymax=s}clone(){return new vt(this.xmin,this.ymin,this.xmax,this.ymax)}get low(){return new i.Point(this.xmin,this.ymin)}get high(){return new i.Point(this.xmax,this.ymax)}get max(){return this.clone()}get center(){return new i.Point((this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)}get width(){return Math.abs(this.xmax-this.xmin)}get height(){return Math.abs(this.ymax-this.ymin)}get box(){return this.clone()}not_intersect(t){return this.xmax<t.xmin||this.xmin>t.xmax||this.ymax<t.ymin||this.ymin>t.ymax}intersect(t){return!this.not_intersect(t)}merge(t){return new vt(this.xmin===void 0?t.xmin:Math.min(this.xmin,t.xmin),this.ymin===void 0?t.ymin:Math.min(this.ymin,t.ymin),this.xmax===void 0?t.xmax:Math.max(this.xmax,t.xmax),this.ymax===void 0?t.ymax:Math.max(this.ymax,t.ymax))}less_than(t){return!!(this.low.lessThan(t.low)||this.low.equalTo(t.low)&&this.high.lessThan(t.high))}equal_to(t){return this.low.equalTo(t.low)&&this.high.equalTo(t.high)}output(){return this.clone()}static comparable_max(t,e){return t.merge(e)}static comparable_less_than(t,e){return t.lessThan(e)}set(t,e,r,s){this.xmin=t,this.ymin=e,this.xmax=r,this.ymax=s}toPoints(){return[new i.Point(this.xmin,this.ymin),new i.Point(this.xmax,this.ymin),new i.Point(this.xmax,this.ymax),new i.Point(this.xmin,this.ymax)]}toSegments(){let t=this.toPoints();return[new i.Segment(t[0],t[1]),new i.Segment(t[1],t[2]),new i.Segment(t[2],t[3]),new i.Segment(t[3],t[0])]}svg(t={}){let{stroke:e,strokeWidth:r,fill:s,id:o,className:a}=t,l=o&&o.length>0?`id="${o}"`:"",f=a&&a.length>0?`class="${a}"`:"",u=this.xmax-this.xmin,h=this.ymax-this.ymin;return`
<rect x="${this.xmin}" y="${this.ymin}" width=${u} height=${h} stroke="${e||"black"}" stroke-width="${r||1}" fill="${s||"none"}" ${l} ${f} />`}};i.Box=vt;var wi=(...n)=>new i.Box(...n);i.box=wi;var ur=class{constructor(t){this.shape=t,this.next=void 0,this.prev=void 0,this.face=void 0,this.arc_length=0,this.bvStart=void 0,this.bvEnd=void 0,this.bv=void 0,this.overlap=void 0}get start(){return this.shape.start}get end(){return this.shape.end}get length(){return this.shape.length}get box(){return this.shape.box}isSegment(){return this.shape instanceof i.Segment}isArc(){return this.shape instanceof i.Arc}middle(){return this.shape.middle()}pointAtLength(t){return this.shape.pointAtLength(t)}contains(t){return this.shape.contains(t)}setInclusion(t){if(this.bv!==void 0)return this.bv;if(this.shape instanceof i.Line||this.shape instanceof i.Ray)return this.bv=i.OUTSIDE,this.bv;if(this.bvStart===void 0&&(this.bvStart=yt(t,this.start)),this.bvEnd===void 0&&(this.bvEnd=yt(t,this.end)),this.bvStart===i.OUTSIDE||this.bvEnd==i.OUTSIDE)this.bv=i.OUTSIDE;else if(this.bvStart===i.INSIDE||this.bvEnd==i.INSIDE)this.bv=i.INSIDE;else{let e=yt(t,this.middle());this.bv=e}return this.bv}setOverlap(t){let e,r=this.shape,s=t.shape;r instanceof i.Segment&&s instanceof i.Segment?r.start.equalTo(s.start)&&r.end.equalTo(s.end)?e=i.OVERLAP_SAME:r.start.equalTo(s.end)&&r.end.equalTo(s.start)&&(e=i.OVERLAP_OPPOSITE):(r instanceof i.Arc&&s instanceof i.Arc||r instanceof i.Segment&&s instanceof i.Arc||r instanceof i.Arc&&s instanceof i.Segment)&&(r.start.equalTo(s.start)&&r.end.equalTo(s.end)&&r.middle().equalTo(s.middle())?e=i.OVERLAP_SAME:r.start.equalTo(s.end)&&r.end.equalTo(s.start)&&r.middle().equalTo(s.middle())&&(e=i.OVERLAP_OPPOSITE)),this.overlap===void 0&&(this.overlap=e),t.overlap===void 0&&(t.overlap=e)}svg(){if(this.shape instanceof i.Segment)return` L${this.shape.end.x},${this.shape.end.y}`;if(this.shape instanceof i.Arc){let t=this.shape,e,r=t.counterClockwise?"1":"0";if(i.Utils.EQ(t.sweep,2*Math.PI)){let s=t.counterClockwise?1:-1,o=new i.Arc(t.pc,t.r,t.startAngle,t.startAngle+s*Math.PI,t.counterClockwise),a=new i.Arc(t.pc,t.r,t.startAngle+s*Math.PI,t.endAngle,t.counterClockwise);return e="0",` A${o.r},${o.r} 0 ${e},${r} ${o.end.x},${o.end.y}
                    A${a.r},${a.r} 0 ${e},${r} ${a.end.x},${a.end.y}`}else return e=t.sweep<=Math.PI?"0":"1",` A${t.r},${t.r} 0 ${e},${r} ${t.end.x},${t.end.y}`}}toJSON(){return this.shape.toJSON()}};i.Edge=ur;var hr=class extends Ut{constructor(t,e){super(t,e);this.setCircularLinks()}setCircularLinks(){this.isEmpty()||(this.last.next=this.first,this.first.prev=this.last)}[Symbol.iterator](){let t;return{next:()=>{let e=t||this.first,r=this.first?t?t===this.first:!1:!0;return t=e?e.next:void 0,{value:e,done:r}}}}append(t){return super.append(t),this.setCircularLinks(),this}insert(t,e){return super.insert(t,e),this.setCircularLinks(),this}remove(t){return super.remove(t),this}},Y=class extends hr{constructor(t,...e){super();if(this._box=void 0,this._orientation=void 0,e.length!=0){if(e.length==1){if(e[0]instanceof Array){let r=e[0];if(r.length==0)return;if(r.every(s=>s instanceof i.Point)){let s=Y.points2segments(r);this.shapes2face(t.edges,s)}else if(r.every(s=>s instanceof Array&&s.length===2)){let s=r.map(a=>new i.Point(a[0],a[1])),o=Y.points2segments(s);this.shapes2face(t.edges,o)}else if(r.every(s=>s instanceof i.Segment||s instanceof i.Arc))this.shapes2face(t.edges,r);else if(r.every(s=>s.name==="segment"||s.name==="arc")){let s=[];for(let o of r){let a;o.name==="segment"?a=new i.Segment(o):a=new i.Arc(o),s.push(a)}this.shapes2face(t.edges,s)}}else if(e[0]instanceof Y){let r=e[0];this.first=r.first,this.last=r.last;for(let s of r)t.edges.add(s)}else if(e[0]instanceof i.Circle)this.shapes2face(t.edges,[e[0].toArc(i.CCW)]);else if(e[0]instanceof i.Box){let r=e[0];this.shapes2face(t.edges,[new i.Segment(new i.Point(r.xmin,r.ymin),new i.Point(r.xmax,r.ymin)),new i.Segment(new i.Point(r.xmax,r.ymin),new i.Point(r.xmax,r.ymax)),new i.Segment(new i.Point(r.xmax,r.ymax),new i.Point(r.xmin,r.ymax)),new i.Segment(new i.Point(r.xmin,r.ymax),new i.Point(r.xmin,r.ymin))])}}e.length==2&&e[0]instanceof i.Edge&&e[1]instanceof i.Edge&&(this.first=e[0],this.last=e[1],this.last.next=this.first,this.first.prev=this.last,this.setArcLength())}}get edges(){return this.toArray()}get shapes(){return this.edges.map(t=>t.shape.clone())}get box(){if(this._box===void 0){let t=new i.Box;for(let e of this)t=t.merge(e.box);this._box=t}return this._box}get perimeter(){return this.last.arc_length+this.last.length}pointAtLength(t){if(t>this.perimeter||t<0)return null;let e=null;for(let r of this)if(t>=r.arc_length&&(r===this.last||t<r.next.arc_length)){e=r.pointAtLength(t-r.arc_length);break}return e}static points2segments(t){let e=[];for(let r=0;r<t.length;r++)t[r].equalTo(t[(r+1)%t.length])||e.push(new i.Segment(t[r],t[(r+1)%t.length]));return e}shapes2face(t,e){for(let r of e){let s=new i.Edge(r);this.append(s),t.add(s)}}append(t){return super.append(t),this.setOneEdgeArcLength(t),t.face=this,this}insert(t,e){return super.insert(t,e),this.setOneEdgeArcLength(t),t.face=this,this}remove(t){return super.remove(t),this.setArcLength(),this}reverse(){let t=[],e=this.last;do e.shape=e.shape.reverse(),t.push(e),e=e.prev;while(e!==this.last);this.first=void 0,this.last=void 0;for(let r of t)this.first===void 0?(r.prev=r,r.next=r,this.first=r,this.last=r):(r.prev=this.last,this.last.next=r,this.last=r,this.last.next=this.first,this.first.prev=this.last),this.setOneEdgeArcLength(r);this._orientation!==void 0&&(this._orientation=void 0,this._orientation=this.orientation())}setArcLength(){for(let t of this)this.setOneEdgeArcLength(t),t.face=this}setOneEdgeArcLength(t){t===this.first?t.arc_length=0:t.arc_length=t.prev.arc_length+t.prev.length}area(){return Math.abs(this.signedArea())}signedArea(){let t=0,e=this.box.ymin;for(let r of this)t+=r.shape.definiteIntegral(e);return t}orientation(){if(this._orientation===void 0){let t=this.signedArea();i.Utils.EQ_0(t)?this._orientation=i.ORIENTATION.NOT_ORIENTABLE:i.Utils.LT(t,0)?this._orientation=i.ORIENTATION.CCW:this._orientation=i.ORIENTATION.CW}return this._orientation}isSimple(t){return Y.getSelfIntersections(this,t,!0).length==0}static getSelfIntersections(t,e,r=!1){let s=[];for(let o of t){let a=e.search(o.box);for(let l of a){if(o===l||l.face!==t||o.shape instanceof i.Segment&&l.shape instanceof i.Segment&&(o.next===l||o.prev===l))continue;let f=o.shape.intersect(l.shape);for(let u of f)if(!(u.equalTo(o.start)&&u.equalTo(l.end)&&l===o.prev)&&!(u.equalTo(o.end)&&u.equalTo(l.start)&&l===o.next)&&(s.push(u),r))break;if(s.length>0&&r)break}if(s.length>0&&r)break}return s}findEdgeByPoint(t){let e;for(let r of this)if(r.shape.contains(t)){e=r;break}return e}toPolygon(){return new i.Polygon(this.shapes)}toJSON(){return this.edges.map(t=>t.toJSON())}svg(){let t=`
M${this.first.start.x},${this.first.start.y}`;for(let e of this)t+=e.svg();return t+=" z",t}};i.Face=Y;var Qt=class{constructor(...t){if(this.pt=new i.Point,this.norm=new i.Vector(0,1),t.length!=0&&(t.length>=1&&t[0]instanceof i.Point&&(this.pt=t[0].clone()),t.length!==1)){if(t.length===2&&t[1]instanceof i.Vector){this.norm=t[1].clone();return}throw i.Errors.ILLEGAL_PARAMETERS}}clone(){return new Qt(this.pt,this.norm)}get slope(){return new i.Vector(this.norm.y,-this.norm.x).slope}get box(){let t=this.slope;return new i.Box(t>Math.PI/2&&t<3*Math.PI/2?Number.NEGATIVE_INFINITY:this.pt.x,t>=0&&t<=Math.PI?this.pt.y:Number.NEGATIVE_INFINITY,t>=Math.PI/2&&t<=3*Math.PI/2?this.pt.x:Number.POSITIVE_INFINITY,t>=Math.PI&&t<=2*Math.PI||t==0?this.pt.y:Number.POSITIVE_INFINITY)}get start(){return this.pt}get end(){}get length(){return Number.POSITIVE_INFINITY}contains(t){if(this.pt.equalTo(t))return!0;let e=new i.Vector(this.pt,t);return i.Utils.EQ_0(this.norm.dot(e))&&i.Utils.GE(e.cross(this.norm),0)}split(t){return this.contains(t)?this.pt.equalTo(t)?[this]:[new i.Segment(this.pt,t),new i.Ray(t,this.norm)]:[]}intersect(t){if(t instanceof i.Segment)return this.intersectRay2Segment(this,t);if(t instanceof i.Arc)return this.intersectRay2Arc(this,t)}intersectRay2Segment(t,e){let r=[],s=new i.Line(t.start,t.norm),o=s.intersect(e);for(let a of o)t.contains(a)&&r.push(a);return o.length==2&&r.length==1&&t.start.on(s)&&r.push(t.start),r}intersectRay2Arc(t,e){let r=[],o=new i.Line(t.start,t.norm).intersect(e);for(let a of o)t.contains(a)&&r.push(a);return r}svg(t,e={}){let r=new i.Line(this.pt,this.norm),s=wt(r,t);return s=s.filter(a=>this.contains(a)),s.length===0||s.length===2?"":new i.Segment(this.pt,s[0]).svg(e)}};i.Ray=Qt;var vi=(...n)=>new i.Ray(...n);i.ray=vi;var J=class{constructor(){this.faces=new i.PlanarSet,this.edges=new i.PlanarSet;let t=[...arguments];if(t.length===1&&(t[0]instanceof Array&&t[0].length>0||t[0]instanceof i.Circle||t[0]instanceof i.Box)){let e=t[0];if(t[0]instanceof Array&&t[0].every(r=>r instanceof Array))if(e.every(r=>r instanceof Array&&r.length===2&&typeof r[0]=="number"&&typeof r[1]=="number"))this.faces.add(new i.Face(this,e));else for(let r of e)if(r instanceof Array&&r[0]instanceof Array&&r[0].every(s=>s instanceof Array&&s.length===2&&typeof s[0]=="number"&&typeof s[1]=="number"))for(let s of r)this.faces.add(new i.Face(this,s));else this.faces.add(new i.Face(this,r));else this.faces.add(new i.Face(this,e))}}get box(){return[...this.faces].reduce((t,e)=>t.merge(e.box),new i.Box)}get vertices(){return[...this.edges].map(t=>t.start)}clone(){let t=new J;for(let e of this.faces)t.addFace(e.shapes);return t}isEmpty(){return this.edges.size===0}isValid(){let t=!0;for(let e of this.faces)if(!e.isSimple(this.edges)){t=!1;break}return t}area(){let t=[...this.faces].reduce((e,r)=>e+r.signedArea(),0);return Math.abs(t)}addFace(...t){let e=new i.Face(this,...t);return this.faces.add(e),e}deleteFace(t){for(let e of t)this.edges.delete(e);return this.faces.delete(t)}recreateFaces(){this.faces.clear();for(let r of this.edges)r.face=null;let t,e=!0;for(;e;){e=!1;for(let r of this.edges)if(r.face===null){t=r,e=!0;break}if(e){let r=t;do r=r.next;while(r.next!==t);this.addFace(t,r)}}}removeChain(t,e,r){if(r.next===e){this.deleteFace(t);return}for(let s=e;s!==r.next;s=s.next)if(t.remove(s),this.edges.delete(s),t.isEmpty()){this.deleteFace(t);break}}addVertex(t,e){let r=e.shape.split(t);if(r[0]===null)return e.prev;if(r[1]===null)return e;let s=new i.Edge(r[0]),o=e.prev;return e.face.insert(s,o),this.edges.delete(e),this.edges.add(s),e.shape=r[1],this.edges.add(e),s}cut(t){let e=[this.clone()];for(let r of t){if(r.setInclusion(this)!==xt)continue;let s=r.shape.start,o=r.shape.end,a=[];for(let l of e)if(l.findEdgeByPoint(s)===void 0)a.push(l);else{let[f,u]=l.cutFace(s,o);a.push(f,u)}e=a}return e}cutFace(t,e){let r=this.findEdgeByPoint(t),s=this.findEdgeByPoint(e);if(r.face!==s.face)return[];let o=this.addVertex(t,r);s=this.findEdgeByPoint(e);let a=this.addVertex(e,s),l=o.face,f=new i.Edge(new i.Segment(o.end,a.end)),u=new i.Edge(new i.Segment(a.end,o.end));o.next.prev=u,u.next=o.next,o.next=f,f.prev=o,a.next.prev=f,f.next=a.next,a.next=u,u.prev=a,this.edges.add(f),this.edges.add(u);let h=this.addFace(f,o),c=this.addFace(u,a);return this.faces.delete(l),[h.toPolygon(),c.toPolygon()]}cutWithLine(t){let e=this.clone(),r=new O([t]),s={int_points1:[],int_points2:[],int_points1_sorted:[],int_points2_sorted:[]};for(let l of e.edges){let f=Ze(l,t);for(let u of f)it(r.first,u,s.int_points1),it(l,u,s.int_points2)}if(s.int_points1.length===0)return e;s.int_points1_sorted=ie(t,s.int_points1),s.int_points2_sorted=_t(s.int_points2),ot(r,s.int_points1_sorted),ot(e,s.int_points2_sorted),xe(s),s.int_points1_sorted=ie(t,s.int_points1),s.int_points2_sorted=_t(s.int_points2),le(s.int_points1),fe(s.int_points1,e);for(let l of s.int_points1_sorted)l.edge_before.bv===l.edge_after.bv&&(s.int_points2[l.id]=-1,l.id=-1);if(s.int_points1=s.int_points1.filter(l=>l.id>=0),s.int_points2=s.int_points2.filter(l=>l.id>=0),s.int_points1.length===0)return e;s.int_points1_sorted=ie(t,s.int_points1),s.int_points2_sorted=_t(s.int_points2);let o=s.int_points1[0],a;for(let l of s.int_points1_sorted)l.edge_before.bv===xt&&(a=new i.Edge(new i.Segment(o.pt,l.pt)),Be(s.int_points2[o.id],s.int_points2[l.id],a),e.edges.add(a),a=new i.Edge(new i.Segment(l.pt,o.pt)),Be(s.int_points2[l.id],s.int_points2[o.id],a),e.edges.add(a)),o=l;return e.recreateFaces(),e}findEdgeByPoint(t){let e;for(let r of this.faces)if(e=r.findEdgeByPoint(t),e!==void 0)break;return e}splitToIslands(){let t=this.toArray();t.sort((s,o)=>o.area()-s.area());let e=[...t[0].faces][0].orientation(),r=t.filter(s=>[...s.faces][0].orientation()===e);for(let s of t){let o=[...s.faces][0];if(o.orientation()!==e){for(let a of r)if(o.shapes.every(l=>a.contains(l))){a.addFace(o.shapes);break}}}return r}reverse(){for(let t of this.faces)t.reverse();return this}contains(t){if(t instanceof i.Point){let e=yt(this,t);return e===xt||e===R}else return sr(this,t)}distanceTo(t){if(t instanceof i.Point){let[e,r]=i.Distance.point2polygon(t,this);return r=r.reverse(),[e,r]}if(t instanceof i.Circle||t instanceof i.Line||t instanceof i.Segment||t instanceof i.Arc){let[e,r]=i.Distance.shape2polygon(t,this);return r=r.reverse(),[e,r]}if(t instanceof i.Polygon){let e=[Number.POSITIVE_INFINITY,new i.Segment],r,s;for(let o of this.edges){let a=e[0];[r,s]=i.Distance.shape2planarSet(o.shape,t.edges,a),i.Utils.LT(r,a)&&(e=[r,s])}return e}}intersect(t){if(t instanceof i.Point)return this.contains(t)?[t]:[];if(t instanceof i.Line)return Gt(t,this);if(t instanceof i.Circle)return tr(t,this);if(t instanceof i.Segment)return we(t,this);if(t instanceof i.Arc)return ve(t,this);if(t instanceof i.Polygon)return ei(t,this)}translate(t){let e=new J;for(let r of this.faces)e.addFace(r.shapes.map(s=>s.translate(t)));return e}rotate(t=0,e=new i.Point){let r=new J;for(let s of this.faces)r.addFace(s.shapes.map(o=>o.rotate(t,e)));return r}transform(t=new i.Matrix){let e=new J;for(let r of this.faces)e.addFace(r.shapes.map(s=>s.transform(t)));return e}toJSON(){return[...this.faces].map(t=>t.toJSON())}toArray(){return[...this.faces].map(t=>t.toPolygon())}svg(t={}){let{stroke:e,strokeWidth:r,fill:s,fillRule:o,fillOpacity:a,id:l,className:f}=t,u=l&&l.length>0?`id="${l}"`:"",h=f&&f.length>0?`class="${f}"`:"",c=`
<path stroke="${e||"black"}" stroke-width="${r||1}" fill="${s||"lightcyan"}" fill-rule="${o||"evenodd"}" fill-opacity="${a||1}" ${u} ${h} d="`;for(let g of this.faces)c+=g.svg();return c+=`" >
</path>`,c}};i.Polygon=J;var Ei=(...n)=>new i.Polygon(...n);i.polygon=Ei;var{Circle:se,Line:je,Point:qe,Vector:Rt,Utils:oe}=i,nt=class{constructor(t){this.circle=t}get inversion_circle(){return this.circle}static inversePoint(t,e){let r=new Rt(t.pc,e),s=t.r*t.r,o=r.dot(r);return oe.EQ_0(o)?new qe(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY):t.pc.translate(r.multiply(s/o))}static inverseCircle(t,e){let r=t.pc.distanceTo(e.pc)[0];if(oe.EQ(r,e.r)){let s=t.r*t.r/(2*e.r),o=new Rt(t.pc,e.pc);o=o.normalize();let a=t.pc.translate(o.multiply(s));return new je(a,o)}else{let s=new Rt(t.pc,e.pc),o=t.r*t.r/(s.dot(s)-e.r*e.r),a=t.pc.translate(s.multiply(o)),l=Math.abs(o)*e.r;return new se(a,l)}}static inverseLine(t,e){let[r,s]=t.pc.distanceTo(e);if(oe.EQ_0(r))return e.clone();{let o=t.r*t.r/(2*r),a=new Rt(t.pc,s.end);return a=a.multiply(o/r),new se(t.pc.translate(a),o)}}inverse(t){if(t instanceof qe)return nt.inversePoint(this.circle,t);if(t instanceof se)return nt.inverseCircle(this.circle,t);if(t instanceof je)return nt.inverseLine(this.circle,t)}};i.Inversion=nt;var Ii=n=>new i.Inversion(n);i.inversion=Ii;var p=class{static point2point(t,e){return t.distanceTo(e)}static point2line(t,e){let r=t.projectionOn(e);return[new i.Vector(t,r).length,new i.Segment(t,r)]}static point2circle(t,e){let[r,s]=t.distanceTo(e.center);if(i.Utils.EQ_0(r))return[e.r,new i.Segment(t,e.toArc().start)];{let o=Math.abs(r-e.r),a=new i.Vector(e.pc,t).normalize().multiply(e.r),l=e.pc.translate(a);return[o,new i.Segment(t,l)]}}static point2segment(t,e){if(e.start.equalTo(e.end))return p.point2point(t,e.start);let r=new i.Vector(e.start,e.end),s=new i.Vector(e.start,t),o=new i.Vector(e.end,t),a=r.dot(s),l=-r.dot(o),f,u;if(i.Utils.GE(a,0)&&i.Utils.GE(l,0)){let h=e.tangentInStart();return f=Math.abs(h.cross(s)),u=e.start.translate(h.multiply(h.dot(s))),[f,new i.Segment(t,u)]}else return a<0?t.distanceTo(e.start):t.distanceTo(e.end)}static point2arc(t,e){let r=new i.Circle(e.pc,e.r),s=[],o,a;return[o,a]=p.point2circle(t,r),a.end.on(e)&&s.push(p.point2circle(t,r)),s.push(p.point2point(t,e.start)),s.push(p.point2point(t,e.end)),p.sort(s),s[0]}static segment2line(t,e){let r=t.intersect(e);if(r.length>0)return[0,new i.Segment(r[0],r[0])];let s=[];return s.push(p.point2line(t.start,e)),s.push(p.point2line(t.end,e)),p.sort(s),s[0]}static segment2segment(t,e){let r=Tt(t,e);if(r.length>0)return[0,new i.Segment(r[0],r[0])];let s=[],o,a;return[o,a]=p.point2segment(e.start,t),s.push([o,a.reverse()]),[o,a]=p.point2segment(e.end,t),s.push([o,a.reverse()]),s.push(p.point2segment(t.start,e)),s.push(p.point2segment(t.end,e)),p.sort(s),s[0]}static segment2circle(t,e){let r=t.intersect(e);if(r.length>0)return[0,new i.Segment(r[0],r[0])];let s=new i.Line(t.ps,t.pe),[o,a]=p.point2line(e.center,s);if(i.Utils.GE(o,e.r)&&a.end.on(t))return p.point2circle(a.end,e);{let[l,f]=p.point2circle(t.start,e),[u,h]=p.point2circle(t.end,e);return i.Utils.LT(l,u)?[l,f]:[u,h]}}static segment2arc(t,e){let r=t.intersect(e);if(r.length>0)return[0,new i.Segment(r[0],r[0])];let s=new i.Line(t.ps,t.pe),o=new i.Circle(e.pc,e.r),[a,l]=p.point2line(o.center,s);if(i.Utils.GE(a,o.r)&&l.end.on(t)){let[c,g]=p.point2circle(l.end,o);if(g.end.on(e))return[c,g]}let f=[];f.push(p.point2arc(t.start,e)),f.push(p.point2arc(t.end,e));let u,h;return[u,h]=p.point2segment(e.start,t),f.push([u,h.reverse()]),[u,h]=p.point2segment(e.end,t),f.push([u,h.reverse()]),p.sort(f),f[0]}static circle2circle(t,e){let r=t.intersect(e);if(r.length>0)return[0,new i.Segment(r[0],r[0])];if(t.center.equalTo(e.center)){let s=t.toArc(),o=e.toArc();return p.point2point(s.start,o.start)}else{let s=new i.Line(t.center,e.center),o=s.intersect(t),a=s.intersect(e),l=[];return l.push(p.point2point(o[0],a[0])),l.push(p.point2point(o[0],a[1])),l.push(p.point2point(o[1],a[0])),l.push(p.point2point(o[1],a[1])),p.sort(l),l[0]}}static circle2line(t,e){let r=t.intersect(e);if(r.length>0)return[0,new i.Segment(r[0],r[0])];let[s,o]=p.point2line(t.center,e),[a,l]=p.point2circle(o.end,t);return l=l.reverse(),[a,l]}static arc2line(t,e){let r=e.intersect(t);if(r.length>0)return[0,new i.Segment(r[0],r[0])];let s=new i.Circle(t.center,t.r),[o,a]=p.point2line(s.center,e);if(i.Utils.GE(o,s.r)){let[l,f]=p.point2circle(a.end,s);if(f.end.on(t))return[l,f]}else{let l=[];return l.push(p.point2line(t.start,e)),l.push(p.point2line(t.end,e)),p.sort(l),l[0]}}static arc2circle(t,e){let r=t.intersect(e);if(r.length>0)return[0,new i.Segment(r[0],r[0])];let s=new i.Circle(t.center,t.r),[o,a]=p.circle2circle(s,e);if(a.start.on(t))return[o,a];{let l=[];return l.push(p.point2circle(t.start,e)),l.push(p.point2circle(t.end,e)),p.sort(l),l[0]}}static arc2arc(t,e){let r=t.intersect(e);if(r.length>0)return[0,new i.Segment(r[0],r[0])];let s=new i.Circle(t.center,t.r),o=new i.Circle(e.center,e.r),[a,l]=p.circle2circle(s,o);if(l.start.on(t)&&l.end.on(e))return[a,l];{let f=[],u,h;return[u,h]=p.point2arc(t.start,e),h.end.on(e)&&f.push([u,h]),[u,h]=p.point2arc(t.end,e),h.end.on(e)&&f.push([u,h]),[u,h]=p.point2arc(e.start,t),h.end.on(t)&&f.push([u,h.reverse()]),[u,h]=p.point2arc(e.end,t),h.end.on(t)&&f.push([u,h.reverse()]),[u,h]=p.point2point(t.start,e.start),f.push([u,h]),[u,h]=p.point2point(t.start,e.end),f.push([u,h]),[u,h]=p.point2point(t.end,e.start),f.push([u,h]),[u,h]=p.point2point(t.end,e.end),f.push([u,h]),p.sort(f),f[0]}}static point2polygon(t,e){let r=[Number.POSITIVE_INFINITY,new i.Segment];for(let s of e.edges){let[o,a]=s.shape instanceof i.Segment?p.point2segment(t,s.shape):p.point2arc(t,s.shape);i.Utils.LT(o,r[0])&&(r=[o,a])}return r}static shape2polygon(t,e){let r=[Number.POSITIVE_INFINITY,new i.Segment];for(let s of e.edges){let[o,a]=t.distanceTo(s.shape);i.Utils.LT(o,r[0])&&(r=[o,a])}return r}static polygon2polygon(t,e){let r=[Number.POSITIVE_INFINITY,new i.Segment];for(let s of t.edges)for(let o of e.edges){let[a,l]=s.shape.distanceTo(o.shape);i.Utils.LT(a,r[0])&&(r=[a,l])}return r}static box2box_minmax(t,e){let r=Math.max(Math.max(t.xmin-e.xmax,0),Math.max(e.xmin-t.xmax,0)),s=Math.max(Math.max(t.ymin-e.ymax,0),Math.max(e.ymin-t.ymax,0)),o=r*r+s*s,a=t.merge(e),l=a.xmax-a.xmin,f=a.ymax-a.ymin,u=l*l+f*f;return[o,u]}static minmax_tree_process_level(t,e,r,s){let o,a;for(let h of e)[o,a]=p.box2box_minmax(t.box,h.item.key),h.item.value instanceof i.Edge?s.insert([o,a],h.item.value.shape):s.insert([o,a],h.item.value),i.Utils.LT(a,r)&&(r=a);if(e.length===0)return r;let l=e.map(h=>h.left.isNil()?void 0:h.left).filter(h=>h!==void 0),f=e.map(h=>h.right.isNil()?void 0:h.right).filter(h=>h!==void 0),u=[...l,...f].filter(h=>{let[c,g]=p.box2box_minmax(t.box,h.max);return i.Utils.LE(c,r)});return r=p.minmax_tree_process_level(t,u,r,s),r}static minmax_tree(t,e,r){let s=new at,o=[e.index.root],a=r<Number.POSITIVE_INFINITY?r*r:Number.POSITIVE_INFINITY;return a=p.minmax_tree_process_level(t,o,a,s),s}static minmax_tree_calc_distance(t,e,r){let s,o;if(e!=null&&!e.isNil()){if([s,o]=p.minmax_tree_calc_distance(t,e.left,r),o)return[s,o];if(i.Utils.LT(s[0],Math.sqrt(e.item.key.low)))return[s,!0];let[a,l]=p.distance(t,e.item.value);return i.Utils.LT(a,s[0])&&(s=[a,l]),[s,o]=p.minmax_tree_calc_distance(t,e.right,s),[s,o]}return[r,!1]}static shape2planarSet(t,e,r=Number.POSITIVE_INFINITY){let s=[r,new i.Segment],o=!1;if(e instanceof i.PlanarSet){let a=p.minmax_tree(t,e,r);[s,o]=p.minmax_tree_calc_distance(t,a.root,s)}return s}static sort(t){t.sort((e,r)=>i.Utils.LT(e[0],r[0])?-1:i.Utils.GT(e[0],r[0])?1:0)}static distance(t,e){return t.distanceTo(e)}};i.Distance=p;i.BooleanOperations=jn;i.Relations=ci;var m=i;var S=class{};W(S,"weaponBox",{spriteName:"weaponBox",frameCount:16}),W(S,"rabbitBreath",{spriteName:"rabbitBreath",frameCount:60}),W(S,"bubbles",{spriteName:"bubbles",frameCount:68}),W(S,"rabbitGo",{spriteName:"rabbitGo",frameCount:24}),W(S,"rabbitPrepareToJump",{spriteName:"rabbitPrepareToJump",frameCount:9}),W(S,"rabbitJumpBack",{spriteName:"rabbitJumpBack",frameCount:30}),W(S,"rabbitJump",{spriteName:"rabbitJump",frameCount:9});var L=class{anim;startTime;constructor(t){this.anim=t,this.startTime=performance.now()}};var Ae=bn(cr());var Ti=typeof global=="object"&&global&&global.Object===Object&&global,dr=Ti;var Si=typeof self=="object"&&self&&self.Object===Object&&self,Ai=dr||Si||Function("return this")(),ut=Ai;var Pi=ut.Symbol,ht=Pi;var pr=Object.prototype,Ci=pr.hasOwnProperty,Oi=pr.toString,St=ht?ht.toStringTag:void 0;function Ni(n){var t=Ci.call(n,St),e=n[St];try{n[St]=void 0;var r=!0}catch{}var s=Oi.call(n);return r&&(t?n[St]=e:delete n[St]),s}var mr=Ni;var ki=Object.prototype,Li=ki.toString;function Bi(n){return Li.call(n)}var gr=Bi;var Ri="[object Null]",Mi="[object Undefined]",xr=ht?ht.toStringTag:void 0;function Fi(n){return n==null?n===void 0?Mi:Ri:xr&&xr in Object(n)?mr(n):gr(n)}var Jt=Fi;function $i(n){return n!=null&&typeof n=="object"}var _r=$i;var Ui="[object Symbol]";function Vi(n){return typeof n=="symbol"||_r(n)&&Jt(n)==Ui}var yr=Vi;var ji=/\s/;function qi(n){for(var t=n.length;t--&&ji.test(n.charAt(t)););return t}var br=qi;var Wi=/^\s+/;function Gi(n){return n&&n.slice(0,br(n)+1).replace(Wi,"")}var wr=Gi;function Di(n){var t=typeof n;return n!=null&&(t=="object"||t=="function")}var U=Di;var vr=0/0,zi=/^[-+]0x[0-9a-f]+$/i,Qi=/^0b[01]+$/i,Yi=/^0o[0-7]+$/i,Ji=parseInt;function Hi(n){if(typeof n=="number")return n;if(yr(n))return vr;if(U(n)){var t=typeof n.valueOf=="function"?n.valueOf():n;n=U(t)?t+"":t}if(typeof n!="string")return n===0?n:+n;n=wr(n);var e=Qi.test(n);return e||Yi.test(n)?Ji(n.slice(2),e?2:8):zi.test(n)?vr:+n}var Er=Hi;var Ir=1/0,Xi=17976931348623157e292;function Ki(n){if(!n)return n===0?n:0;if(n=Er(n),n===Ir||n===-Ir){var t=n<0?-1:1;return t*Xi}return n===n?n:0}var At=Ki;function Zi(n){var t=At(n),e=t%1;return t===t?e?t-e:t:0}var Tr=Zi;var ts="[object AsyncFunction]",es="[object Function]",rs="[object GeneratorFunction]",ns="[object Proxy]";function is(n){if(!U(n))return!1;var t=Jt(n);return t==es||t==rs||t==ts||t==ns}var Ht=is;var ss=ut["__core-js_shared__"],Xt=ss;var Sr=function(){var n=/[^.]+$/.exec(Xt&&Xt.keys&&Xt.keys.IE_PROTO||"");return n?"Symbol(src)_1."+n:""}();function os(n){return!!Sr&&Sr in n}var Ar=os;var as=Function.prototype,ls=as.toString;function fs(n){if(n!=null){try{return ls.call(n)}catch{}try{return n+""}catch{}}return""}var Pr=fs;var us=/[\\^$.*+?()[\]{}|]/g,hs=/^\[object .+?Constructor\]$/,cs=Function.prototype,ds=Object.prototype,ps=cs.toString,ms=ds.hasOwnProperty,gs=RegExp("^"+ps.call(ms).replace(us,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function xs(n){if(!U(n)||Ar(n))return!1;var t=Ht(n)?gs:hs;return t.test(Pr(n))}var Cr=xs;function _s(n,t){return n==null?void 0:n[t]}var Or=_s;function ys(n,t){var e=Or(n,t);return Cr(e)?e:void 0}var Kt=ys;var bs=9007199254740991,ws=/^(?:0|[1-9]\d*)$/;function vs(n,t){var e=typeof n;return t=t??bs,!!t&&(e=="number"||e!="symbol"&&ws.test(n))&&n>-1&&n%1==0&&n<t}var Nr=vs;function Es(n,t){return n===t||n!==n&&t!==t}var Zt=Es;var Is=9007199254740991;function Ts(n){return typeof n=="number"&&n>-1&&n%1==0&&n<=Is}var kr=Ts;function Ss(n){return n!=null&&kr(n.length)&&!Ht(n)}var Lr=Ss;function As(n,t,e){if(!U(e))return!1;var r=typeof t;return(r=="number"?Lr(e)&&Nr(t,e.length):r=="string"&&t in e)?Zt(e[t],n):!1}var Br=As;var Ps=Kt(Object,"create"),V=Ps;function Cs(){this.__data__=V?V(null):{},this.size=0}var Rr=Cs;function Os(n){var t=this.has(n)&&delete this.__data__[n];return this.size-=t?1:0,t}var Mr=Os;var Ns="__lodash_hash_undefined__",ks=Object.prototype,Ls=ks.hasOwnProperty;function Bs(n){var t=this.__data__;if(V){var e=t[n];return e===Ns?void 0:e}return Ls.call(t,n)?t[n]:void 0}var Fr=Bs;var Rs=Object.prototype,Ms=Rs.hasOwnProperty;function Fs(n){var t=this.__data__;return V?t[n]!==void 0:Ms.call(t,n)}var $r=Fs;var $s="__lodash_hash_undefined__";function Us(n,t){var e=this.__data__;return this.size+=this.has(n)?0:1,e[n]=V&&t===void 0?$s:t,this}var Ur=Us;function ct(n){var t=-1,e=n==null?0:n.length;for(this.clear();++t<e;){var r=n[t];this.set(r[0],r[1])}}ct.prototype.clear=Rr;ct.prototype.delete=Mr;ct.prototype.get=Fr;ct.prototype.has=$r;ct.prototype.set=Ur;var Ee=ct;function Vs(){this.__data__=[],this.size=0}var Vr=Vs;function js(n,t){for(var e=n.length;e--;)if(Zt(n[e][0],t))return e;return-1}var D=js;var qs=Array.prototype,Ws=qs.splice;function Gs(n){var t=this.__data__,e=D(t,n);if(e<0)return!1;var r=t.length-1;return e==r?t.pop():Ws.call(t,e,1),--this.size,!0}var jr=Gs;function Ds(n){var t=this.__data__,e=D(t,n);return e<0?void 0:t[e][1]}var qr=Ds;function zs(n){return D(this.__data__,n)>-1}var Wr=zs;function Qs(n,t){var e=this.__data__,r=D(e,n);return r<0?(++this.size,e.push([n,t])):e[r][1]=t,this}var Gr=Qs;function dt(n){var t=-1,e=n==null?0:n.length;for(this.clear();++t<e;){var r=n[t];this.set(r[0],r[1])}}dt.prototype.clear=Vr;dt.prototype.delete=jr;dt.prototype.get=qr;dt.prototype.has=Wr;dt.prototype.set=Gr;var Dr=dt;var Ys=Kt(ut,"Map"),zr=Ys;function Js(){this.size=0,this.__data__={hash:new Ee,map:new(zr||Dr),string:new Ee}}var Qr=Js;function Hs(n){var t=typeof n;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?n!=="__proto__":n===null}var Yr=Hs;function Xs(n,t){var e=n.__data__;return Yr(t)?e[typeof t=="string"?"string":"hash"]:e.map}var z=Xs;function Ks(n){var t=z(this,n).delete(n);return this.size-=t?1:0,t}var Jr=Ks;function Zs(n){return z(this,n).get(n)}var Hr=Zs;function to(n){return z(this,n).has(n)}var Xr=to;function eo(n,t){var e=z(this,n),r=e.size;return e.set(n,t),this.size+=e.size==r?0:1,this}var Kr=eo;function pt(n){var t=-1,e=n==null?0:n.length;for(this.clear();++t<e;){var r=n[t];this.set(r[0],r[1])}}pt.prototype.clear=Qr;pt.prototype.delete=Jr;pt.prototype.get=Hr;pt.prototype.has=Xr;pt.prototype.set=Kr;var Ie=pt;var ro="Expected a function";function Te(n,t){if(typeof n!="function"||t!=null&&typeof t!="function")throw new TypeError(ro);var e=function(){var r=arguments,s=t?t.apply(this,r):r[0],o=e.cache;if(o.has(s))return o.get(s);var a=n.apply(this,r);return e.cache=o.set(s,a)||o,a};return e.cache=new(Te.Cache||Ie),e}Te.Cache=Ie;var mt=Te;var no="Expected a function";function io(n,t){var e;if(typeof t!="function")throw new TypeError(no);return n=Tr(n),function(){return--n>0&&(e=t.apply(this,arguments)),n<=1&&(t=void 0),e}}var Zr=io;function so(n){return Zr(2,n)}var Se=so;var oo=Math.floor,ao=Math.random;function lo(n,t){return n+oo(ao()*(t-n+1))}var tn=lo;var fo=parseFloat,uo=Math.min,ho=Math.random;function co(n,t,e){if(e&&typeof e!="boolean"&&Br(n,t,e)&&(t=e=void 0),e===void 0&&(typeof t=="boolean"?(e=t,t=void 0):typeof n=="boolean"&&(e=n,n=void 0)),n===void 0&&t===void 0?(n=0,t=1):(n=At(n),t===void 0?(t=n,n=0):t=At(t)),n>t){var r=n;n=t,t=r}if(e||n%1||t%1){var s=ho();return uo(n+s*(t-n+fo("1e-"+((s+"").length-1))),t)}return tn(n,t)}var gt=co;var Pe=class{#t;#e;polygons;#r=[];isPointInsideTerrain;intersectCircle2Box;intersectBox2Terrain;intersects;constructor(t){this.intersects=mt(this.#n.bind(this),l=>{let{cache:f}=this.intersects;return f.size===3e4&&f.clear(),`${l.xmin}_${l.xmax}_${l.ymin}_${l.ymax}`}),this.intersectCircle2Box=mt((l,f)=>l.intersect(f),(l,f)=>`${f.xmin}_${f.xmax}_${f.ymin}_${f.ymax}_${l.pc.x}_${l.pc.y}_${l.r}`),this.isPointInsideTerrain=mt(this.#i.bind(this),l=>`${l.x}_${l.y}`),this.intersectBox2Terrain=mt(this.#s.bind(this),l=>`${l.xmin}_${l.xmax}_${l.ymin}_${l.ymax}`),this.polygons=t;let e=[],r=[];for(let l of t)for(let f of l)e.push(f.x),r.push(f.y);let s=Math.max(...e)-Math.min(...e),o=Math.max(...r)-Math.min(...r);this.#t=new Ae.default({x:0,y:0,width:s,height:o},5,16),this.#e=new Ae.default({x:0,y:0,width:s,height:o});let a=0;for(let l of this.polygons){let f=[...l];f.unshift(f[f.length-1]);for(let u=1;u<f.length;u++){let h=f[u-1],c=f[u],g=new m.Segment(new m.Point(h.x,h.y),new m.Point(c.x,c.y)),_=g.box,v=performance.now();this.#t.insert({x:_.xmin,y:_.ymin,width:_.xmax-_.xmin,height:_.ymax-_.ymin,seg:g}),a+=performance.now()-v}}for(let l of this.polygons){let f=l.map(h=>h.x),u=l.map(h=>h.y);this.#r.push(new m.Box(Math.min(...f),Math.min(...u),Math.max(...f),Math.max(...u)))}}makeHole(t,e,r){let s=new m.Circle(new m.Point(t,e),r),o=s.box;this.#e.insert({x:o.xmin,y:o.ymin,width:o.xmax-o.xmin,height:o.ymax-o.ymin,circle:s}),this.intersects.cache.clear()}#n(t){for(let{cache:o}of[this.isPointInsideTerrain,this.intersectCircle2Box,this.intersectBox2Terrain])o.size===3e4&&o.clear();let e=this.#e.retrieve({x:t.xmin,y:t.ymin,width:t.xmax-t.xmin,height:t.ymax-t.ymin}).filter(o=>new m.Box(o.x,o.y,o.x+o.width,o.y+o.height).intersect(t)),r=(o,a)=>{for(let{circle:l}of e)if(a!==l&&l.contains(o))return!1;return!0},s=this.intersectBox2Terrain(t).filter(o=>(o.points=o.points.filter(r),o.points.length>0));for(let{circle:o}of e){let a=this.intersectCircle2Box(o,t).filter(l=>r(l,o)?this.isPointInsideTerrain(l):!1);a.length>0&&s.push({circle:o,points:a})}return s}#i(t){let e=0;return this.polygons.forEach((r,s)=>{this.#r[s].intersect(t.box)&&po(t,r)!==-1&&e++}),e%2!==0}#s(t){let e=[],r={x:t.xmin,y:t.ymin,width:t.xmax-t.xmin,height:t.ymax-t.ymin};for(let{seg:s}of this.#t.retrieve(r)){let o=s.intersect(t);o.length>0&&e.push({seg:s,points:o})}return e}};function po(n,t){let e=0;for(let r=0;r<t.length;++r){let s=t[r],o=t[(r+1)%t.length],a=(n.y-s.y)*(o.x-s.x)-(n.x-s.x)*(o.y-s.y);if(a===0)return 0;t[r].y<=n.y?t[(r+1)%t.length].y>n.y&&a>0&&++e:t[(r+1)%t.length].y<n.y&&a<0&&--e}return e!==0?1:-1}var N=class{x;y;velocity;constructor(t,e,r=0,s=0){this.x=t,this.y=e,this.velocity=new m.Vector(r,s)}beforeUpdate(t){}onEntityCollide(t){}onOutOfWorld(t){}onUnderwater(){}onGroundCollide(t,e,r){return!0}onResolve(t,e){}};var Ce=new Map;function en(n){for(let t of d.gameEntities){Ce.set(t,{x:t.x,y:t.y,velocity:t.velocity.clone()});let e=1/n;if(t.beforeUpdate(e),t.type===1){let r=new m.Vector(0,1540);t.velocity=t.velocity.add(r.multiply(e))}t.x+=t.velocity.x*e,t.y+=t.velocity.y*e}for(let t of d.gameEntities){for(let o of d.gameEntities){if(o===t)continue;let a=new m.Box(t.x,t.y,t.x+t.width,t.y+t.height),l=new m.Box(o.x,o.y,o.x+o.width,o.y+o.height);a.intersect(l)&&t.onEntityCollide(o)}t.y<=-5e3||t.x>=5e3||t.x<=-5e3?(t.onOutOfWorld(!1),d.gameEntities.delete(t)):t.y>=d.waterOffset+150&&(t.onOutOfWorld(!0),d.gameEntities.delete(t)),t.y>=d.waterOffset-t.height&&t.onUnderwater();let e=t.x-d.terrainOffsetX,r=t.y-d.terrainOffsetY,s=d.terrain.intersects(new m.Box(e,r,e+t.width,r+t.height));if(s.length>0){if(!t.onGroundCollide(e,r,s))continue;let a=Ce.get(t);if(t.x=a.x,t.y=a.y,t.velocity=a.velocity,t.velocity.length<t.bounceThreshold){t.velocity=new m.Vector,t.onResolve(!0,s);continue}let l=s[0],f;l.circle?f=new m.Vector(l.points[0],l.circle.pc).normalize():f=new m.Vector(l.seg.ps,l.seg.pe).rotate90CCW().normalize();let u=f.multiply(t.velocity.dot(f)),h=t.velocity.subtract(u);t.velocity=h.multiply(t.COF).subtract(u.multiply(t.COR))}t.onResolve(!1,s)}Ce.clear()}var mo={Date:!0,RegExp:!0,String:!0,Number:!0};function te(n,t,e={cyclesFix:!0},r=[]){let s=[],o=Array.isArray(n);for(let l in n){let f=n[l],u=o?+l:l;if(!(l in t)){s.push({type:"REMOVE",path:[u],oldValue:n[l]});continue}let h=t[l],c=typeof f=="object"&&typeof h=="object";if(f&&h&&c&&!mo[Object.getPrototypeOf(f).constructor.name]&&(e.cyclesFix?!r.includes(f):!0)){let g=te(f,h,e,e.cyclesFix?r.concat([f]):[]);s.push.apply(s,g.map(_=>(_.path.unshift(u),_)))}else f!==h&&!(c&&(isNaN(f)?f+""==h+"":+f==+h))&&s.push({path:[u],type:"CHANGE",value:h,oldValue:f})}let a=Array.isArray(t);for(let l in t)l in n||s.push({type:"CREATE",path:[a?+l:l],value:t[l]});return s}var Pt=class extends N{type=1;width=15;height=25;COF=.3;COR=.5;bounceThreshold=75;angle=0;boom=Se(()=>{setTimeout(()=>{d.holes2.push({cx:this.x,cy:this.y,r:75}),d.terrain.makeHole(this.x,this.y,75),d.gameEntities.delete(this),P("grenadeExplosion");let t=new m.Circle(new m.Point(this.x,this.y),90);for(let e of d.gameEntities)for(let r of new m.Box(e.x,e.y,e.x+e.width,e.y+e.height).toPoints())if(t.contains(r)){console.log("cont");let s=new m.Vector(0,-1e3);e.velocity=e.velocity.add(s);break}},1e3)});beforeUpdate(t){let e=s(this.velocity.slope),r=40;this.angle+=this.velocity.length/r*(e>270||e<90?1:-1)*t,this.angle%=Math.PI*2;function s(o){var a=Math.PI;return o*(180/a)}}onResolve(t,e){e.length>0&&!t&&P("grenadeBounce"),t&&this.boom()}onOutOfWorld(t){t&&P("waterSplash1")}};var Ct=class extends N{type=1;width=20;height=20;COF=1;COR=1;bounceThreshold=1e3;beforeUpdate(t){let e=new m.Vector(-1e3,0);this.velocity=this.velocity.add(e.multiply(t))}onOutOfWorld(t){t&&P("waterSplash1")}onGroundCollide(t,e,r){return this.boom(),!1}boom(){d.holes2.push({cx:this.x,cy:this.y,r:75}),d.terrain.makeHole(this.x,this.y,75),d.gameEntities.delete(this),P("rocketExplosion")}};var Ot=class extends N{type=0;width=10;height=10;COF=1;COR=1;bounceThreshold=1e3;beforeUpdate(t){}onOutOfWorld(t){t&&P("waterSplash1")}onGroundCollide(t,e,r){return this.boom(),!1}boom(){d.holes2.push({cx:this.x,cy:this.y,r:30}),d.terrain.makeHole(this.x,this.y,30),d.gameEntities.delete(this),P("grenadeExplosion")}};var Nt=class extends N{type=0;width=10;height=10;COF=1;COR=1;bounceThreshold=1e3;pin=!1;beforeUpdate(t){let e=[...d.characters][0];if(this.pin===!1){let r=e.collider;new m.Vector(new m.Point(r.x,r.y),new m.Point(this.x+this.width/2,this.y+this.height/2)).length>=450&&d.gameEntities.delete(this)}}onGroundCollide(t,e,r){if(this.velocity=new m.Vector(0,0),this.pin===!1){let o=[...d.characters][0].collider;o.type=0,o.pointX=this.x+this.width/2,o.pointY=this.y+this.height/2;let a=o.x+o.width/2,l=o.y+o.height/2,f=o.pointX,u=o.pointY,c=o.velocity.slope*180/Math.PI;o.magnitude=(c>=270||c<=90?o.velocity.length:-o.velocity.length)/2,o.velocity=new m.Vector(0,0),o.width=10,o.height=10,o.testGavnina=!0,o.pin=!0;let g=new m.Vector(new m.Point(o.x+o.width/2,o.y+o.height/2),new m.Point(this.x+this.width/2,this.y+this.height/2));g=g.rotate90CCW().rotate90CCW();let _=g.length;_-=20,o.r=_,o.x=o.pointX+_*Math.cos(g.slope)-o.width/2,o.y=o.pointY+_*Math.sin(g.slope)-o.height/2,o.deattach=()=>{o.type=1,o.width=13,o.height=60,o.testGavnina=!1,o.r=0,o.pin=!1,d.gameEntities.delete(this)}}return this.pin=!0,!1}};var rn=n=>{let e=[...d.characters][0].collider;e.r+=n;let r=new m.Vector(new m.Point(e.x+e.width/2,e.y+e.height/2),new m.Point(e.pointX,e.pointY));r=r.rotate90CCW().rotate90CCW(),e.x=e.pointX+e.r*Math.cos(r.slope)-e.width/2,e.y=e.pointY+e.r*Math.sin(r.slope)-e.height/2};globalThis.onmessage=n=>{let t=n.data,e=t.params,r=[...d.characters][0];switch(t.method){case"join":{let s=new re(gt(300,2900),-300);d.gameEntities.add(s);let o=new Ne(s,t.params.nickname??"\u041F\u0435\u0442\u044F",Math.random()>.5?1:0);o.animState=new L(S.rabbitBreath),d.characters.add(o),globalThis.postMessage({type:"debug",data:d.terrain.polygons}),Oe(!0),setTimeout(Oe,1e3/sn);break}case"stopMoving":r.stopMoving();break;case"startMoving":r.startMoving(e.direction);break;case"startJumping":r.startJumping(e.direction);break;case"setWeapon":globalThis.curWeap=e.name;break;case"fireTest":on(e.angle,e.force);break;case"toggleBulletTime":globalThis.bulletTime=!globalThis.bulletTime;break;case"incRadius":r.collider.pin===!0&&rn(-6);break;case"decRadius":r.collider.pin===!0&&rn(6);break;case"deattach":r.collider.pin===!0&&r.collider.deattach();break;case"makeHole":return d.holes2.push({cx:e.cx,cy:e.cy,r:60}),d.terrain.makeHole(e.cx,e.cy,60),new Response(JSON.stringify({result:{data:""}}))}};var nn={},sn=64;async function Oe(n=!1){let t={characters:[...d.characters].map(r=>({name:r.name,health:r.health,team:r.team,colX:r.collider.x,colY:r.collider.y,colWidth:r.collider.width,colHeight:r.collider.height,direction:r.looksToLeft,visual:r.animState})),weaponBoxes:[...d.weaponBoxes].map(r=>({colX:r.collider.x,colY:r.collider.y,colWidth:r.collider.width,colHeight:r.collider.height,creationTime:r.creationTime})),holes:[...d.holes2],meta:{terrainOffsetX:d.terrainOffsetX,terrainOffsetY:d.terrainOffsetY,waterOffset:d.waterOffset}};t.testGrenades=[];for(let r of d.gameEntities)r instanceof Pt&&t.testGrenades.push({x:r.x,y:r.y,w:r.width,h:r.height,angle:r.angle});t.testBullets=[];for(let r of d.gameEntities)r instanceof Ot&&t.testBullets.push({x:r.x,y:r.y,w:r.width,h:r.height,angle:r.velocity.slope});t.testBazookas=[];for(let r of d.gameEntities)r instanceof Ct&&t.testBazookas.push({x:r.x,y:r.y,w:r.width,h:r.height,angle:r.velocity.slope});t.testHookShot=[];for(let r of d.gameEntities)r instanceof Nt&&t.testHookShot.push({x:r.x,y:r.y,w:r.width,h:r.height});let e=te(nn,t,{cyclesFix:!1});nn=t,n?globalThis.postMessage({type:"fullSnapshot",data:t}):globalThis.postMessage({type:"patch",data:e}),setTimeout(Oe,1e3/sn)}function P(n){globalThis.postMessage({type:"playSound",data:n})}globalThis.curWeap="bazooka";var ke=144;function an(n){Le({terrain:new Pe(n),waterOffset:1260,gameEntities:new Set,characters:new Set,weaponBoxes:new Set,holes2:[],terrainOffsetX:0,terrainOffsetY:0}),setInterval(function(){if(d.weaponBoxes.size===30)return;let r=new fn(gt(300,2900),-300);d.gameEntities.add(r.collider),d.weaponBoxes.add(r)},3e3),setInterval(go,1e3/ke)}var re=class extends N{type=1;width=13;height=60;COF=.7;COR=.15;bounceThreshold=1100;testGavnina=!1;pointX;pointY;magnitude=0;test=0;r=0;pin=!1;beforeUpdate(t){if(this.testGavnina===!1)return;let e=this.x+this.width/2,r=this.y+this.height/2,s=this.pointX,o=this.pointY,a=new m.Vector(new m.Point(e,r),new m.Point(s,o)),l=a.slope*180/Math.PI;this.magnitude+=(l>=270||l<=90?140:-140)*t,this.magnitude*=.999-this.test;let f=a.normalize().multiply(this.magnitude),u=f.rotate90CCW();this.velocity=u.add(f.multiply(t))}onGroundCollide(t,e,r){let s=e,o=e+this.height,a=e+this.height*.75,l;for(let f of r)for(let u of f.points)if(u.y>=a){l=!0;break}if(l===!0)for(let f of d.characters)f.collider===this&&(f.animState.anim.spriteName==="rabbitJump"||f.animState.anim.spriteName==="rabbitJumpBack")&&(f.animState=new L(S.rabbitBreath));return!0}onResolve(t){if(d.characters.size){let e=[...d.characters][0],r=e.collider;if(r.velocity.length>90){e.animState.anim.spriteName==="rabbitGo"&&(e.animState=new L(S.rabbitBreath));return}if(globalThis.walkingMode){let l=function(){let u=150/ke*(e.looksToLeft?-1:1),h=0;for(let c=a;c<=a*8;c+=a)if(d.terrain.intersects(new m.Box(s+u,o+c,s+u+r.width,o+c+r.height)).length!==0){h=c-a;break}if(h>0){r.y+=h,r.x+=u;return}for(let c=0;c<=a*7;c+=a)if(d.terrain.intersects(new m.Box(s+u,o-c,s+u+r.width,o-c+r.height)).length===0){r.y-=c,r.x+=u;return}},s=r.x-d.terrainOffsetX,o=r.y-d.terrainOffsetY,a=7.5/8;l()}}}onUnderwater(){this.velocity=new m.Vector,this.x=gt(300,2900),this.y=-300}},ln=class extends N{type=1;width=30;height=30;COF=.7;COR=.15;bounceThreshold=100;onOutOfWorld(){}onEntityCollide(t){t instanceof re&&(d.gameEntities.delete(this),[...d.weaponBoxes].forEach(e=>{e.collider===this&&d.weaponBoxes.delete(e)}))}},fn=class{collider;creationTime;constructor(t,e){this.collider=new ln(t,e),this.creationTime=performance.now()}},Ne=class{collider;looksToLeft;name;health;team;animState;constructor(t,e,r){this.collider=t,this.looksToLeft=!1,this.name=e,this.health=530,this.team=r}get isGrounded(){return this.collider.velocity.x===0&&this.collider.velocity.y===0}startMoving(t){this.animState.anim.spriteName!=="rabbitPrepareToJump"&&this.isGrounded&&(this.looksToLeft=t,globalThis.walkingMode=!0,this.animState.anim.spriteName!=="rabbitGo"&&(this.animState=new L(S.rabbitGo)))}stopMoving(){delete globalThis.walkingMode,this.animState.anim.spriteName==="rabbitGo"&&(this.animState=new L(S.rabbitBreath))}startJumping(t){this.animState.anim.spriteName!=="rabbitPrepareToJump"&&(globalThis.walkingMode||this.isGrounded)&&(delete globalThis.walkingMode,globalThis.startJumpAnim=t,this.animState=new L(S.rabbitPrepareToJump))}};function go(){for(let n of d.characters)if(n.animState.anim.spriteName==="rabbitPrepareToJump"){let t=performance.now()-n.animState.startTime,e=1e3/24;t>=n.animState.anim.frameCount*e&&(globalThis.startJumpAnim==="FORWARD"?(n.collider.velocity=new m.Vector(n.looksToLeft?-265:265,-420),n.animState=new L(S.rabbitJump)):(n.collider.velocity=new m.Vector(n.looksToLeft?60:-60,-575),n.animState=new L(S.rabbitJumpBack)))}en(ke*(globalThis.bulletTime?7:1))}function on(n,t){let e=[...d.characters][0],r=1500;t<1e3&&(r=75*Math.ceil(t/50)),curWeap==="rifle"?r=1500:curWeap==="hook"&&(r=1400);let s=(e.looksToLeft?n+90:450-n)*Math.PI/180,o=r*Math.cos(s),a=r*Math.sin(s);switch(curWeap){case"gren":d.gameEntities.add(new Pt(e.collider.x,e.collider.y,o,a)),P("grenadeAttack");break;case"bazooka":d.gameEntities.add(new Ct(e.collider.x,e.collider.y,o,a)),P("rocketAttack");break;case"rifle":P("grenadeAttack"),d.gameEntities.add(new Ot(e.collider.x,e.collider.y,o,a));break;case"hook":d.gameEntities.add(new Nt(e.collider.x,e.collider.y,o,a)),P("grenadeAttack");break}}(async()=>{try{let n=await fetch("./TreesRewamp.json");if(n.ok===!1)throw new Error("");an(await n.json())}catch(n){throw n}})();})();
/**
 * @license
 * Lodash (Custom Build) <https://lodash.com/>
 * Build: `lodash modularize exports="es" -o ./`
 * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */
/**
 * quadtree-js
 * @version 1.2.5
 * @license MIT
 * @author Timo Hausmann
 */
